function getPointInRhombus(px,py){var x1,y1,x2,y2;var mx,my,mx1,my1,mx2,my2;var cx,cy;x1=parseInt(px/half_tile_width);y1=parseInt(py/tile_height_offset);mx1=px%half_tile_width;my1=py%tile_height_offset;if(mx1+my1<half_tile_width+tile_height_offset){}mx=x1*half_tile_width;my=y1*tile_height_offset;if((x1+y1)%2!=0){cx=mx+half_tile_width;cy=my+tile_height_offset;}else{my=my+tile_height_offset;cx=mx+half_tile_width;cy=my-tile_height_offset;}var r1,r2;r1=Math.abs(mx-px)+Math.abs(my-py);r2=Math.abs(cx-px)+Math.abs(cy-py);if(r1<r2){px=mx;py=my;}else{px=cx;py=cy;}return parseInt(pos2loc(px,py));}function pos2loc(posX,posY){var x,y;x=(2*posY+posX-itemStartX-half_tile_width)/(half_tile_width*2);y=(posY-tile_height_offset-tile_height_offset*x)/tile_height_offset;if(x<0||y<0||x>=map_arr_width||y>=map_arr_height){return-1;}return y*map_arr_width+x;}function pos2loc_test(posX,posY){var x,y;x=(2*posY+posX-half_bg_width-half_tile_width)/(half_tile_width*2);y=(posY-tile_height_offset-tile_height_offset*x)/tile_height_offset;alert(x+":"+y);}function loc2pos(loc){var x,y;var lx,ly;ly=parseInt(loc/map_arr_width);lx=loc%map_arr_width;if(lx==map_arr_width-1){lx=-1;ly=ly+1;}x=itemStartX+half_tile_width*lx-half_tile_width*ly;y=tile_height_offset+tile_height_offset*lx+tile_height_offset*ly;return Array(x,y);}function loc2pos_absolute(loc){var x,y;var lx,ly;ly=parseInt(loc/map_arr_width);lx=loc%map_arr_width;x=half_bg_width+half_tile_width*lx-half_tile_width*ly;y=tile_height_offset+tile_height_offset*lx+tile_height_offset*ly;return Array(x,y);}function is_terrain_passable(nid){for(var i=0;i<map_mark.length;i++){if(nid==map_mark[i]){return true;}}return false;}function Hash(){this.length=0;this.items=new Array;for(var i=0;i<arguments.length;i+=2){if(typeof arguments[i+1]!="undefined"){this.items[arguments[i]]=arguments[i+1];this.length++;}}this.removeItem=function(in_key){var tmp_previous;if(typeof this.items[in_key]!="undefined"){this.length--;var tmp_previous=this.items[in_key];delete this.items[in_key];}return tmp_previous;};this.getItem=function(in_key){return this.items[in_key];};this.setItem=function(in_key,in_value){var tmp_previous;if(typeof in_value!="undefined"){if(typeof this.items[in_key]=="undefined"){this.length++;}else{tmp_previous=this.items[in_key];}this.items[in_key]=in_value;}return tmp_previous;};this.hasItem=function(in_key){return typeof this.items[in_key]!="undefined";};this.clear=function(){for(var i in this.items){delete this.items[i];}this.length=0;};this.getLength=function(){return this.length;};}function createTwoDimensionArray(n,m){var arr=new Array(n);for(var i=0;i<n;i++){arr[i]=new Array(m);}return arr;}function in_obj_array(v,a){for(key in a){if(a[key].pos==v){return true;}}return false;}function spriteMoveProcess_ht5(thisSprite){var playerPathArr=new Array;var rc=parseInt(thisSprite.repeatPathCnt);var anID=parseInt(thisSprite.anID);var pathstr=thisSprite.path.toString();var dir;playerPathArr=pathstr.split(",");var playerCnt=thisSprite.getPathCntVal();var pos=playerPathArr[playerCnt];var rl=6;var norl=2;if(pos){thisPos=parseInt(playerPathArr[playerCnt]);nextPos=parseInt(playerPathArr[playerCnt+1]);if(nextPos==thisPos+map_arr_width-1){if(rc<rl){rc++;thisSprite.pos=thisPos;}else if(rc>=rl){rc=0;thisSprite.pos=nextPos;playerCnt++;}thisSprite.repeatPathCnt=rc;thisSprite.dir=6;}else if(nextPos==thisPos-map_arr_width+1){if(rc<rl){rc++;thisSprite.pos=thisPos;}else if(rc>=rl){rc=0;thisSprite.pos=nextPos;playerCnt++;}thisSprite.repeatPathCnt=rc;thisSprite.dir=2;}else if(nextPos==thisPos+1){if(rc<norl){rc++;thisSprite.pos=thisPos;}else if(rc>=norl){rc=0;thisSprite.pos=nextPos;playerCnt++;}thisSprite.repeatPathCnt=rc;thisSprite.dir=5;}else if(nextPos==thisPos-1){if(rc<norl){rc++;thisSprite.pos=thisPos;}else if(rc>=norl){rc=0;thisSprite.pos=nextPos;playerCnt++;}thisSprite.repeatPathCnt=rc;thisSprite.dir=3;}else if(nextPos==thisPos+map_arr_width){if(rc<norl){rc++;thisSprite.pos=thisPos;}else if(rc>=norl){rc=0;thisSprite.pos=nextPos;playerCnt++;}thisSprite.repeatPathCnt=rc;thisSprite.dir=7;}else if(nextPos==thisPos-map_arr_width){if(rc<norl){rc++;thisSprite.pos=thisPos;}else if(rc>=norl){rc=0;thisSprite.pos=nextPos;playerCnt++;}thisSprite.repeatPathCnt=rc;thisSprite.dir=1;}else if(nextPos==thisPos+map_arr_width+1){if(rc<norl){rc++;thisSprite.pos=thisPos;}else if(rc>=norl){rc=0;thisSprite.pos=nextPos;playerCnt++;}thisSprite.repeatPathCnt=rc;thisSprite.dir=8;}else if(nextPos==thisPos-map_arr_width-1){if(rc<norl){rc++;thisSprite.pos=thisPos;}else if(rc>=norl){rc=0;thisSprite.pos=nextPos;playerCnt++;}thisSprite.repeatPathCnt=rc;thisSprite.dir=0;}thisSprite.pathCnt=playerCnt;anID++;if(anID>paceNum){anID=0;}if(playerCnt+1>=playerPathArr.length){anID=0;}thisSprite.anID=anID;}else{}return thisSprite;}function spriteMoveProcess(thisSprite){var playerPathArr=new Array;var spriteID=parseInt(thisSprite.attr("spriteID"));var spriteHeight=parseInt(thisSprite.attr("spriteHeight"));var rc=parseInt(thisSprite.attr("repeatPathCnt"));var pathstr=thisSprite.attr("path").toString();var anID=parseInt(thisSprite.attr("anID"));playerPathArr=pathstr.split(",");var playerCnt=parseInt(thisSprite.attr("pathCnt"));var pos=playerPathArr[playerCnt];var paceNum=6;if(spriteID<1000){paceNum=6;}else if(spriteID>=1000&&spriteID<2000){paceNum=2;}else{paceNum=4;}if(pos){thisPos=parseInt(playerPathArr[playerCnt]);nextPos=parseInt(playerPathArr[playerCnt+1]);if(nextPos==thisPos+map_arr_width-1){if(rc<6){rc++;thisSprite[0].pos=thisPos;}else if(rc>=6){rc=0;thisSprite[0].pos=nextPos;playerCnt++;}thisSprite.attr("repeatPathCnt",rc);thisSprite.attr("direction",6);}else if(nextPos==thisPos-map_arr_width+1){if(rc<6){rc++;thisSprite[0].pos=thisPos;}else if(rc>=6){rc=0;thisSprite[0].pos=nextPos;playerCnt++;}thisSprite.attr("repeatPathCnt",rc);thisSprite.attr("direction",2);}else if(nextPos==thisPos+1){if(rc<2){rc++;thisSprite[0].pos=thisPos;}else if(rc>=2){rc=0;thisSprite[0].pos=nextPos;playerCnt++;}thisSprite.attr("repeatPathCnt",rc);thisSprite.attr("direction",5);}else if(nextPos==thisPos-1){if(rc<2){rc++;thisSprite[0].pos=thisPos;}else if(rc>=2){rc=0;thisSprite[0].pos=nextPos;playerCnt++;}thisSprite.attr("repeatPathCnt",rc);thisSprite.attr("direction",3);}else if(nextPos==thisPos+map_arr_width){if(rc<2){rc++;thisSprite[0].pos=thisPos;}else if(rc>=2){rc=0;thisSprite[0].pos=nextPos;playerCnt++;}thisSprite.attr("repeatPathCnt",rc);thisSprite.attr("direction",7);}else if(nextPos==thisPos-map_arr_width){if(rc<2){rc++;thisSprite[0].pos=thisPos;}else if(rc>=2){rc=0;thisSprite[0].pos=nextPos;playerCnt++;}thisSprite.attr("repeatPathCnt",rc);thisSprite.attr("direction",1);}else if(nextPos==thisPos+map_arr_width+1){if(rc<2){rc++;thisSprite[0].pos=thisPos;}else if(rc>=2){rc=0;thisSprite[0].pos=nextPos;playerCnt++;}thisSprite.attr("repeatPathCnt",rc);thisSprite.attr("direction",8);}else if(nextPos==thisPos-map_arr_width-1){if(rc<2){rc++;thisSprite[0].pos=thisPos;}else if(rc>=2){rc=0;thisSprite[0].pos=nextPos;playerCnt++;}thisSprite.attr("repeatPathCnt",rc);thisSprite.attr("direction",0);}var pa=loc2pos(parseInt(thisSprite[0].pos));var dir=parseInt(thisSprite.attr("direction"));if(dir==6){posX=pa[0]-rc*8;posY=pa[1]-spriteHeight;}else if(dir==2){posX=pa[0]+rc*8;posY=pa[1]-spriteHeight;}else if(dir==5){posX=pa[0]+rc*8;posY=pa[1]-spriteHeight+rc*4;}else if(dir==3){posX=pa[0]-rc*8;posY=pa[1]-spriteHeight-rc*4;}else if(dir==1){posX=pa[0]+rc*8;posY=pa[1]-spriteHeight-rc*4;}else if(dir==7){posX=pa[0]-rc*8;posY=pa[1]-spriteHeight+rc*4;}else if(dir==0){posX=pa[0];posY=pa[1]-spriteHeight-rc*8;}else if(dir==8){posX=pa[0];posY=pa[1]-spriteHeight+rc*8;}else{posX=pa[0];posY=pa[1]-spriteHeight;dir=1;}thisSprite.css("left",posX);posY=posY-screen_height_offset;thisSprite.css("top",posY);thisSprite.attr("pathCnt",playerCnt);var thisImg=imgByDir(spriteID,dir);anID++;if(anID>paceNum){anID=0;}if(playerCnt+1>=playerPathArr.length){anID=0;}thisSprite.attr("src","res/spriteRes/"+spriteID+"/"+thisImg+"_"+anID+".png");thisSprite.attr("anID",anID);}return thisSprite;}function spriteDir(thisPos,nextPos){thisPos=parseInt(thisPos);nextPos=parseInt(nextPos);var dir=-1;if(nextPos==thisPos+1){dir=5;}else if(nextPos==thisPos-1){dir=3;}else if(nextPos==thisPos+map_arr_width){dir=7;}else if(nextPos==thisPos-map_arr_width){dir=1;}else if(nextPos==thisPos+map_arr_width+1){dir=8;}else if(nextPos==thisPos+map_arr_width-1){dir=6;}else if(nextPos==thisPos-map_arr_width+1){dir=2;}else if(nextPos==thisPos-map_arr_width-1){dir=0;}return dir;}function imgByDir(spriteID,dir){var imgHead=spriteID+"_10";if(dir==0){imgHead=spriteID+"_11";}else if(dir==1){imgHead=spriteID+"_10";}else if(dir==2){imgHead=spriteID+"_10";}else if(dir==3){imgHead=spriteID+"_11";}else if(dir==5){imgHead=spriteID+"_12";}else if(dir==6){imgHead=spriteID+"_13";}else if(dir==7){imgHead=spriteID+"_13";}else if(dir==8){imgHead=spriteID+"_12";}else{imgHead=spriteID+"_10";}return imgHead;}function imgByDir_cha(spriteID,dir){if(dir==0){imgHead="lu";}else if(dir==1){imgHead="ru";}else if(dir==2){imgHead="ru";}else if(dir==3){imgHead="lu";}else if(dir==5){imgHead="rd";}else if(dir==6){imgHead="ld";}else if(dir==7){imgHead="ld";}else if(dir==8){imgHead="rd";}else{imgHead="ru";}return imgHead;}function htmlPosStrToNumber(val){return parseInt(val.substring(0,val.length-2));}function getNameLable(name,dispname){var obj;if($("#"+name)[0]){obj=$("#"+name)[0];}else{var obj=document.createElement("DIV");obj.setAttribute("id",name);obj.setAttribute("align","center");obj.style.position="absolute";obj.style.width="135px";obj.style.zIndex=99;obj.style.fontSize="20px";obj.innerHTML=getNameLableStyle(dispname);}return obj;}function getNameLableStyle(name){return"<br><div align='center' style='background: white;width:70px;z-index:10;font-size:18px'><b>"+name+"</b></div>";}function getChatBubbleStyle(content){return"<p class='triangle-isosceles'>"+content+"</p>";}function update_la_content(thisID,content,thisDispName){var obj=getNameLable(thisID,thisDispName);if(content==""){obj.innerHTML=getNameLableStyle(thisDispName);}else{obj.innerHTML=getChatBubbleStyle(content)+obj.innerHTML;chatmsg="&nbsp<font color='blue'>"+thisID+":</font>"+content+"<br>"+chatmsg;$("lay").html(chatmsg);}}function removePlayerLable(thisID){var lable_obj=$("#"+thisID);lable_obj.remove();}function showPlayerLable(thisID){var lable_obj=$("#"+thisID);lable_obj.css("display","");}function hidePlayerLable(thisID){var lable_obj=$("#"+thisID);lable_obj.css("display","none");}function isBGImg(imgid){if(imgid==1||imgid==2){return true;}return false;}function isTerrainImg(src){if(src.indexOf("/10.png")!=-1&&hideBg==1){return true;}return false;}function getItemOffset(iid){var iid_arr=iid.toString().split("_");if(map_offset[iid]){if(iid_arr.length>1){var iid_1=iid_arr[0];var iid_2=iid_arr[1];if(parseInt(iid_2)==0){return map_offset[iid];}else{return 0;}}else{return map_offset[iid];}}else{return 0;}}function point(x,y,w,h,i,src,id){var _img=document.createElement("img");_img.setAttribute("type","pointImg");_img.src=src;_img.id=id;_img.style.position="absolute";_img.style.left=x+"px";_img.style.top=y+"px";_img.style.width=w+"px";_img.style.height=h+"px";_img.style.zIndex=i;$("#lay0").append(_img);}function createRect(x,y,x1,y1,src){clearRect();point(x,y,x1-x,1,9999,"point.jpg","l1");point(x1,y,1,y1-y,9999,"point.jpg","l2");point(x,y,1,y1-y,9999,"point.jpg","l3");point(x,y1,x1-x,1,9999,"point.jpg","l4");}function clearRect(){var jobj=$("IMG[type='pointImg']");for(var i=0;i<jobj.length;i++){var other_obj=$("#"+jobj[i].id);other_obj.remove();}}function setToOrder(arr){arr.sort(function(x1,x2){var x1_x=loc2pos_absolute(x1)[0];var x2_x=loc2pos_absolute(x2)[0];return x1_x-x2_x;});return arr;}function setHashOrder(arr){arr.sort(function(x1,x2){var x1_x=x1.getPos();var x2_x=x2.getPos();return x1_x-x2_x;});return arr;}function debugMsg(msg){$("#debuginfo").val(msg);}function uuidlet(){return((1+Math.random())*65536|0).toString(16).substring(1);}function getuuid(p){uuid_default_prefix=p;p=p||uuid_default_prefix||"";return p+uuidlet()+uuidlet()+"-"+uuidlet()+"-"+uuidlet()+"-"+uuidlet()+"-"+uuidlet()+uuidlet()+uuidlet();}function in_array(v,a){for(var i=0;i<a.length;i++){if(a[i]==v){return false;}}return true;}function setProgress(val){eval("$( \"#progressbar\" ).progressbar({value:"+val+"})");}function isloaded(){if(version==2){$("#layLoading").remove();}else{var spriteloaded=roomRes.loadedRec.getItem(main_img_id).loaded;var loadedMapImgCnt=roomRes.mapResHash.getLength();if(loadedMapImgCnt==itemNum&&spriteloaded==spriteNum){$("#layLoading").remove();$("#lay0").css("display","");$("#startDiv").css("display","");}}}function getTransformProperty(element){var properties=["transform","WebkitTransform","MozTransform","msTransform","OTransform"];var p;while((p=properties.shift())){if(typeof element.style[p]!="undefined"){return p;}}return false;}function isActContent(content){if(content.startWith("&&")){return true;}else if(unescape(content).startWith("&&")){return true;}return false;}function isClothContent(content){if(content.startWith(">>")){return true;}else if(unescape(content).startWith(">>")){return true;}return false;}function getWidth(){xWidth=null;if(window.screen!=null){xWidth=window.screen.width;}if(window.innerWidth!=null){xWidth=window.innerWidth;}if(document.body!=null){xWidth=document.body.clientWidth;}return xWidth;}function getHeight(){xHeight=null;if(window.screen!=null){xHeight=window.screen.height;}if(window.innerHeight!=null){xHeight=window.innerHeight;}if(document.body!=null){xHeight=document.body.clientHeight;}return xHeight;}String.prototype.startWith=function(str){var reg=new RegExp("^"+str);return reg.test(this);};String.prototype.startWith=function(str){var reg=new RegExp("^"+str);return reg.test(this);};String.prototype.replaceAll=function(s1,s2){var r=new RegExp(s1.replace(/([\(\)\[\]\{\}\^\$\+\-\*\?\.\"\'\|\/\\])/g,"\\$1"),"ig");return this.replace(r,s2);};var ResLoad=function(){this.mapResHash=new Hash;this.spriteResHash=new Hash;this.loadedRec=new Hash;this.loadedMapImgCnt=0;this.loadedSpriteImgCnt=0;};ResLoad.prototype={map_res_load:function(map_data,type){this.loadedMapImgCnt=0;for(var i=0;i<map_data.length;i++){if(!isBGImg(map_data[i])){var key=map_data[i];if(!this.mapResHash.hasItem(key)){var map_img=new Image;var dir=key.split("_")[0];map_img.src="res/mapRes/up/"+dir+"/"+key+".png";map_img.onload=this.load_map_count_up;this.mapResHash.setItem(key,map_img);if(type==1&&key.split("_")[1]&&key.split("_")[1]==0){map_img.src="res/mapRes/up/"+dir+"/"+key.split("_")[0]+".png";map_img.onload=this.load_map_count_up;this.mapResHash.setItem(key.split("_")[0],map_img);}}}}},sprite_res_load:function(spriteID,dirCnt,frameCnt){this.loadedSpriteImgCnt=0;var recObj=new Object;recObj.total=dirCnt*frameCnt;recObj.loaded=0;this.loadedRec.setItem(spriteID,recObj);for(var i=0;i<dirCnt;i++){for(var j=0;j<frameCnt;j++){var key=spriteID+"_1"+i+"_"+j;var sprite_img=new Image;sprite_img.src="res/spriteRes/"+spriteID+"/"+key+".png";sprite_img.onload=this.load_sprite_count_up(spriteID);this.spriteResHash.setItem(key,sprite_img);}}},get_sprite_img:function(img_name){var key=img_name;return this.spriteResHash.getItem(key);},load_map_count_up:function(){},load_sprite_count_up:function(spriteID){var o=roomRes.loadedRec.getItem(spriteID);o.loaded=o.loaded+1;roomRes.loadedRec.setItem(spriteID,o);isloaded();},isSpriteLoaded:function(spriteID){var o=roomRes.loadedRec.getItem(spriteID);if(o&&o.loaded==o.total){return true;}return false;},get_map_img:function(img_name){var key=img_name;return this.mapResHash.getItem(key);},set_sprite:function(sprite_head){},get_sprite:function(){}};var orgin_arr_width=8;var target_arr_width=map_arr_width;function getImageArr(firstNode,item_mark_arr_ordered){var ret=[];ret[0]=firstNode;var target_item_pos_row_off=parseInt(firstNode/target_arr_width);var target_item_pos_col_off=parseInt(firstNode%target_arr_width);var first_item_pos_row_off=parseInt(item_mark_arr_ordered[0]/orgin_arr_width);var first_item_pos_col_off=parseInt(item_mark_arr_ordered[0]%orgin_arr_width);for(var i=1;i<item_mark_arr_ordered.length;i++){var row_off=parseInt(item_mark_arr_ordered[i]/orgin_arr_width);var col_off=parseInt(item_mark_arr_ordered[i]%orgin_arr_width);var t_row_off=target_item_pos_row_off+(row_off-first_item_pos_row_off);var t_col_off=target_item_pos_col_off+(col_off-first_item_pos_col_off);if(t_col_off>=target_arr_width||t_col_off<0||t_row_off>=target_arr_width||t_row_off<0){ret[ret.length]=-1;}else{ret[ret.length]=t_row_off*target_arr_width+t_col_off;}}return ret;}function getLeftNode(vl,t1,t2){var vl_row_off=parseInt(vl/target_arr_width);var vl_col_off=parseInt(vl%target_arr_width);var t1_row_off=parseInt(t1/orgin_arr_width);var t1_col_off=parseInt(t1%orgin_arr_width);var t2_row_off=parseInt(t2/orgin_arr_width);var t2_col_off=parseInt(t2%orgin_arr_width);var ro=t1_row_off-t2_row_off;var co=t1_col_off-t2_col_off;var ret_row_off=vl_row_off-ro;var ret_col_off=vl_col_off-co;var ret;if(ret_col_off>=target_arr_width||ret_col_off<0||ret_row_off>=target_arr_width||ret_row_off<0){ret=-1;}else{ret=ret_row_off*target_arr_width+ret_col_off;}return ret;}function getItemBottomNode(arr){var ret=0;for(var i=0;i<arr.length;i++){if(arr[i]>ret){ret=arr[i];}}return ret;}function getItemLeftNode(arr){return arr[0];}function clearOriginMap(bPos,item_mark_arr_ordered_str){var item_mark_arr_ordered=item_mark_arr_ordered_str.split(",");var leftNode=getLeftNode(bPos,getItemBottomNode(item_mark_arr_ordered),getItemLeftNode(item_mark_arr_ordered));if(leftNode==-1){return false;}var imageArr=getImageArr(leftNode,item_mark_arr_ordered);if(!checkImageArr(imageArr)){return false;}for(var i=0;i<imageArr.length;i++){map_all_update[imageArr[i]]=1;}return true;}function setTargetMap(bPos,item_mark_arr_ordered_str,item_mark_arr_ordered_subitems_str){var item_mark_arr_ordered=item_mark_arr_ordered_str.split(",");var item_mark_arr_ordered_subitems=item_mark_arr_ordered_subitems_str.split("||");var leftNode=getLeftNode(bPos,getItemBottomNode(item_mark_arr_ordered),getItemLeftNode(item_mark_arr_ordered));if(leftNode==-1){return false;}var imageArr=getImageArr(leftNode,item_mark_arr_ordered);if(!checkImageArr(imageArr)){return false;}if(isAvailable(imageArr)){for(var i=0;i<imageArr.length;i++){map_all_update[imageArr[i]]=item_mark_arr_ordered_subitems[i];}}else{return false;}return true;}function isAvailable(imageArr){var ret=true;for(var i=0;i<imageArr.length;i++){if(!isBGImg(map_all_update[imageArr[i]])){ret=ret&false;}}return ret;}function checkImageArr(arr){for(var i=0;i<arr.length;i++){if(arr[i]==-1){return false;}}return true;}function CR_baseTiles(imgCode,posX,posY,pos){var iid=pos+1;var a=document.createElement("IMG");a.pos=pos;a.setAttribute("id",iid);a.setAttribute("type","tile");var r=imgCode.split("_");if(r.length==1){a.setAttribute("src","res/mapRes/up/"+imgCode+"/"+imgCode+".png");}else{a.setAttribute("src","res/mapRes/up/"+r[0]+"/"+r[0]+".png");}a.setAttribute("imgCode",r[0]);a.style.position="absolute";if(r.length==1){posX=posX-getItemOffset(map_all[pos]);}else{posX=posX-img_offset[r[0]];}a.style.left=posX;a.style.top=posY+tile_height-a.height;a.style.zIndex=pos;if(!isSafari){a.onmouseover=function(){a.style.opacity=0.6;};a.onmouseout=function(){a.style.opacity=1;};a.ondrag=function(){return false;};a.onmousedown=function(){sd.set(a,r[0]);var ob=sd.ob;ob.style.opacity=0.6;temp_imgCode=imgCode;if(commandCtl._getCmd()=="move"){moveCtrl(imgMV,sd);}else if(commandCtl._getCmd()=="del"){delCtrl(imgMV,sd);}else if(commandCtl._getCmd()=="col"){colCtrl(imgMV,sd);}};}else{a.ontouchstart=function(e){e.preventDefault();sd.set(a,r[0]);var ob=sd.ob;ob.style.opacity=0.6;temp_imgCode=imgCode;imgMV=ob.id;if(commandCtl._getCmd()=="move"){moveCtrl(isDrag,sd);}else if(commandCtl._getCmd()=="del"){isDrag=0;delCtrl(imgMV,sd);}else if(commandCtl._getCmd()=="col"){colCtrl(imgMV,sd);}};a.ontouchend=function(e){if(isDrag==1){a.style.opacity=1;setMapAct();isDrag=0;}};}return a;}function move(dir){var ps=$("#map").css("backgroundPosition");var ps_x=parseInt(ps.split(" ")[0]);var ps_y=parseInt(ps.split(" ")[1]);var offx,offy;var hs=60;var ws=64;if(dir==0){screen_height_offset-=hs;ps_y+=hs;offy=hs;}else if(dir==1){screen_height_offset+=hs;ps_y-=hs;offy=-hs;}else if(dir==2){half_bg_width+=ws;ps_x+=ws;offx=ws;}else if(dir==3){half_bg_width-=ws;ps_x-=ws;offx=-ws;}ix=half_bg_width-tile_width/2;iy=0-screen_height_offset;target_pos=0;ps_x=ps_x+"px";ps_y=ps_y+"px";var ss=ps_x+" "+ps_y;$("#map").css("backgroundPosition",ss);updateMap(offx,offy);}var m_offx=0;var m_offy=0;function moves(ox,oy){var ps=$("#map").css("backgroundPosition");var ps_x=parseInt(ps.split(" ")[0]);var ps_y=parseInt(ps.split(" ")[1]);target_pos=0;ps_x+=ox;m_offx+=ox;ps_y+=oy;m_offy+=oy;ps_x=ps_x+"px";ps_y=ps_y+"px";var ss=ps_x+" "+ps_y;$("#map").css("backgroundPosition",ss);updateMap(ox,oy);}var tx=0;var ty=0;var sx=0;var sy=0;var isScrMoving=0;var md_cnt=0;var isMouseDown=0;var dura=0;function endMoveEventFunction(e){e.preventDefault();tx=0;ty=0;sx=0;sy=0;isScrMoving=0;dura=0;setTimeout(function(){isScrMoving=0;},300);}function mapEditScreenMove(mx,my){var td=(new Date).getTime()-dura;if(td<scr_scroll_speed){return false;}dura=(new Date).getTime();var ox,oy,tmp;if(sx==0&&sy==0){sx=mx;sy=my;}else{ox=mx-sx;oy=my-sy;var ps=$("#map").css("backgroundPosition");var ps_x=parseInt(ps.split(" ")[0]);var ps_y=parseInt(ps.split(" ")[1]);moves(ox,oy);}}function moveEventFunction(e){var p=getCoords(e.touches[0]);if(p.y<100){return;}isScrMoving=1;md_cnt++;if(e.touches&&md_cnt>3){md_cnt=0;mapEditScreenMove(p.x,p.y);}return false;}function moveMSEventFunction(e){var ox,oy,tmp;md_cnt++;if(isMouseDown==1){md_cnt=0;isScrMoving=1;var evt=window.event||e;md_cnt=0;mapEditScreenMove(evt.clientX,evt.clientY);}return false;}function m_down(){isMouseDown=1;}function endMSMoveEventFunction(e){tx=0;ty=0;sx=0;sy=0;isMouseDown=0;setTimeout(function(){isScrMoving=0;},300);}function CR_consor(imgCode,posX,posY,pos,sid){var a=document.createElement("IMG");a.id=sid;a.pos=pos;a.setAttribute("type","tile");a.setAttribute("src","res/mapRes/"+main_map_id+"_"+imgCode+".png");a.style.position="absolute";a.style.left=posX;a.style.top=posY+tile_height-a.height;a.style.zIndex=9999;a.onclick=function(){alert(this.pos);};return a;}function CR_item(imgCode,posX,posY,pos,sid,off,sub_item,sub_loc){var a=document.createElement("IMG");a.setAttribute("id",sid);a.pos=pos;a.off=off;a.setAttribute("type","tile");a.setAttribute("imgCode",imgCode);a.setAttribute("src","res/mapRes/up/"+imgCode+"/"+imgCode+".png");a.style.position="absolute";a.style.left=posX;a.style.top=posY+tile_height-a.height;a.style.zIndex=pos;a.style.display="none";if(!isSafari){a.onmouseover=function(){a.style.opacity=0.6;};a.onmouseout=function(){a.style.opacity=1;};a.ondrag=function(){return false;};a.onmousedown=function(){sd.set(a,imgCode);var ob=sd.ob;ob.style.opacity=0.6;temp_imgCode=imgCode;if(commandCtl._getCmd()=="move"){moveCtrl(imgMV,sd);}else if(commandCtl._getCmd()=="del"){delCtrl(imgMV,sd);}else if(commandCtl._getCmd()=="col"){colCtrl(imgMV,sd);}};}else{a.ontouchstart=function(e){e.preventDefault();sd.set(a,imgCode);var ob=sd.ob;ob.style.opacity=0.6;temp_imgCode=imgCode;imgMV=ob.id;if(commandCtl._getCmd()=="move"){moveCtrl(isDrag,sd);}else if(commandCtl._getCmd()=="del"){isDrag=0;delCtrl(imgMV,sd);}else if(commandCtl._getCmd()=="col"){colCtrl(imgMV,sd);}};a.ontouchend=function(e){if(isDrag==1){a.style.opacity=1;setMapAct();isDrag=0;}};}return a;}var mvArr=Array();function drawMap(ix,iy){var px,py;var line_start_x,line_start_y;var mvArr_cnt=0;mvArr=Array();for(var i=0;i<map_arr_width;i++){line_start_x=ix-i*(tile_width/2);line_start_y=iy+i*tile_height_offset;for(var j=0;j<map_arr_height;j++){px=line_start_x+j*(tile_width/2);py=line_start_y+j*tile_height_offset;if(!isBGImg(map_all[i*map_arr_width+j])&&isEndItem(map_all[i*map_arr_width+j],i*map_arr_width+j)){var img_obj=CR_baseTiles(map_all[i*map_arr_width+j],px,py,i*map_arr_width+j);$(img_obj).draggable();mvArr[mvArr_cnt]=img_obj;mvArr_cnt++;}}}}function updateMap(offx,offy){$("#lay0").children("img").each(function(){thisX=parseInt($(this).css("left"));thisY=parseInt($(this).css("top"));thisX=thisX+offx+"px";thisY=thisY+offy+"px";$(this).css("left",thisX);$(this).css("top",thisY);});}function isEndItem(imgCode,pos){var r=imgCode.split("_");var ret=false;if(r.length==1){ret=true;}else{var c=imgCode.split("_");var c1=map_enditem[c[0]]+",";pos=pos+",";if(c1.indexOf(pos)!=-1){ret=true;}}return ret;}function mapReload(){var t;for(var i=0;i<mvArr.length;i++){if(mvArr[i]&&!isTerrainImg(mvArr[i].src)){$("#lay0").append(mvArr[i]);}}}