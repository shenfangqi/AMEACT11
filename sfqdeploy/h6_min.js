function setCycle(){var a="";var b="";a=otherSprites.get_req_str();b="pol_test2.php?room="+room_id+"&user="+user+"&sidhash="+a+"&cidhash="+get_cid_str()+"&sID="+main_img_id+"&sHI="+player_img_height+"&sWI="+player_img_width;$.ajax({type:"GET",url:b,dataType:"text",async:false,success:function(a){if(a=="NG"){clearInterval(cycleID);alert("You are time out for this site.");window.location.href="/AMEACT"}else{var b=a.split("__");removeNoExistPlayers(b[0]);if(b[1]!=""){set_other_path(b[1])}if(b[2]!=""){set_chat_msg(b[2])}intervalChatMsg()}}})}function get_cid_str(){var a=otherSprites.get_other_cid_str();var b=mainsprite.getCid();var c=user;cid_str=c+":"+b+"||"+a;return cid_str}function set_chat_msg(a){var b=a.split("||");var c=0;var d;for(var e=0;e<b.length;e++){var f=b[e].split(":");var g=f[1];if(isActContent(g))c=1;else if(isClothContent(g))c=2;var h=f[2];if(f[0]!=user){d=otherSprites.get_sprite(f[0]);if(d){if(c==0){d.setContent(g);d.setCid(h);d.setSayTime(5);update_la_content(f[0],unescape(g),d.getDispName())}else if(c==2){if(h>d.cid){var i=g.substring(2);var j=i.replace(/~/g,":");var k=j.replace(/--/g,"||");k=k.substring(0,k.length-1);var l=new human(or,k);l.animator(anistr);d.setCid(h);d.setHuman(l);otherSprites.set_sprite(f[0],d)}}else{d.setCid(h);d.setActStr(g);d.setActCntVal(0);otherSprites.set_sprite(f[0],d)}}}else{mainsprite.setCid(h)}}}function removeNoExistPlayers(a){otherSprites.removePlayerImg(a)}function intervalChatMsg(){otherSprites.intervalOthersChatMsg();var a=parseInt(mainsprite.getSayTime("sayTime"));if(a>-1){a--;mainsprite.setSayTime(a)}else{update_la_content(user,"",myname)}}function set_other_cloth(a){var b=a.split(":");var c=b[1];thisSprite=otherSprites.get_sprite(b[0]);if(thisSprite){var d=c.substring(2);var e=d.replace(/~/g,":");var f=e.replace(/--/g,"||");var g=new human(or,f);g.animator(anistr);thisSprite.setHuman(g);otherSprites.set_sprite(b[0],thisSprite)}}function set_other_chat(a){var b=a.split(":");var c=b[1];thisSprite=otherSprites.get_sprite(b[0]);if(thisSprite){thisSprite.setContent(c);thisSprite.setSayTime(20);update_la_content(b[0],unescape(c),thisSprite.getDispName())}}function set_other_act(a){var b=a.split(":");var c=b[1];thisSprite=otherSprites.get_sprite(b[0]);if(thisSprite){thisSprite.setActStr(c);thisSprite.setActCntVal(0);otherSprites.set_sprite(b[0],thisSprite)}}function set_other_path(a){var b=new Array(10);var c=a.split("||");var d;for(var e=0;e<c.length;e++){var f=c[e].split(":");var g=f[3];var h=f[4];var i;if(g<1e3){i=6}else if(g>=1e3&&g<2e3){i=2}else{i=4}var j=player_img_height;var k=player_img_width;if(!otherSprites.is_exist(f[0])){var l=new Sprite;l.setPos(f[2]);l.setImg(g);l.setUser(f[0]);l.setSID(f[1]);l.setPathVal(f[2]);l.setWidth(player_img_width);l.setHeight(j);l.setWidth(k);l.setPathCntVal(0);l.setRepeatPathCnt(0);l.setCid(-1);l.setDispName(f[3]);var m;if(f[4]!==undefined){var n=f[4];n=n.replaceAll("~~","||");n=n.replaceAll(";",":");m=n}var o=new human(or,m);o.animator(anistr);l.setHuman(o);otherSprites.set_sprite(f[0],l)}else{var l=otherSprites.get_sprite(f[0]);l.setPathQue(f[2]);otherSprites.set_sprite(f[0],l)}}}function move_otherPlayers(){var a;otherSprites.set_sprites_path();otherSprites.move_step();mainsprite.move_main_player();intervalChatMsg();ca.mapReload()}function set_main_heart(){target_pos=mainsprite.getPos();firstCloSend=true;mainsprite.setPath()}function getPointInRhombus(a,b){var c,d,e,f;var g,h,i,j,k,l;var m,n;c=parseInt(a/half_tile_width);d=parseInt(b/tile_height_offset);i=a%half_tile_width;j=b%tile_height_offset;if(i+j<half_tile_width+tile_height_offset){}g=c*half_tile_width;h=d*tile_height_offset;if((c+d)%2!=0){m=g+half_tile_width;n=h+tile_height_offset}else{h=h+tile_height_offset;m=g+half_tile_width;n=h-tile_height_offset}var o,p;o=Math.abs(g-a)+Math.abs(h-b);p=Math.abs(m-a)+Math.abs(n-b);if(o<p){a=g;b=h}else{a=m;b=n}return parseInt(pos2loc(a,b))}function pos2loc(a,b){var c,d;c=(2*b+a-itemStartX-half_tile_width)/(half_tile_width*2);d=(b-tile_height_offset-tile_height_offset*c)/tile_height_offset;if(c<0||d<0||c>=map_arr_width||d>=map_arr_height){return-1}return d*map_arr_width+c}function pos2loc_test(a,b){var c,d;c=(2*b+a-half_bg_width-half_tile_width)/(half_tile_width*2);d=(b-tile_height_offset-tile_height_offset*c)/tile_height_offset;alert(c+":"+d)}function loc2pos(a){var b,c;var d,e;e=parseInt(a/map_arr_width);d=a%map_arr_width;if(d==map_arr_width-1){d=-1;e=e+1}b=itemStartX+half_tile_width*d-half_tile_width*e;c=tile_height_offset+tile_height_offset*d+tile_height_offset*e;return Array(b,c)}function loc2pos_absolute(a){var b,c;var d,e;e=parseInt(a/map_arr_width);d=a%map_arr_width;b=half_bg_width+half_tile_width*d-half_tile_width*e;c=tile_height_offset+tile_height_offset*d+tile_height_offset*e;return Array(b,c)}function is_terrain_passable(a){for(var b=0;b<map_mark.length;b++){if(a==map_mark[b])return true}return false}function Hash(){this.length=0;this.items=new Array;for(var a=0;a<arguments.length;a+=2){if(typeof arguments[a+1]!="undefined"){this.items[arguments[a]]=arguments[a+1];this.length++}}this.removeItem=function(a){var b;if(typeof this.items[a]!="undefined"){this.length--;var b=this.items[a];delete this.items[a]}return b};this.getItem=function(a){return this.items[a]};this.setItem=function(a,b){var c;if(typeof b!="undefined"){if(typeof this.items[a]=="undefined"){this.length++}else{c=this.items[a]}this.items[a]=b}return c};this.hasItem=function(a){return typeof this.items[a]!="undefined"};this.clear=function(){for(var a in this.items){delete this.items[a]}this.length=0};this.getLength=function(){return this.length}}function createTwoDimensionArray(a,b){var c=new Array(a);for(var d=0;d<a;d++){c[d]=new Array(b)}return c}function in_obj_array(a,b){for(key in b){if(b[key].pos==a)return true}return false}function spriteMoveProcess_ht5(a){var b=new Array;var c=parseInt(a.repeatPathCnt);var d=parseInt(a.anID);var e=a.path.toString();var f;b=e.split(",");var g=a.getPathCntVal();var h=b[g];var i=6;var j=2;if(h){thisPos=parseInt(b[g]);nextPos=parseInt(b[g+1]);if(nextPos==thisPos+map_arr_width-1){if(c<i){c++;a.pos=thisPos}else if(c>=i){c=0;a.pos=nextPos;g++}a.repeatPathCnt=c;a.dir=6}else if(nextPos==thisPos-map_arr_width+1){if(c<i){c++;a.pos=thisPos}else if(c>=i){c=0;a.pos=nextPos;g++}a.repeatPathCnt=c;a.dir=2}else if(nextPos==thisPos+1){if(c<j){c++;a.pos=thisPos}else if(c>=j){c=0;a.pos=nextPos;g++}a.repeatPathCnt=c;a.dir=5}else if(nextPos==thisPos-1){if(c<j){c++;a.pos=thisPos}else if(c>=j){c=0;a.pos=nextPos;g++}a.repeatPathCnt=c;a.dir=3}else if(nextPos==thisPos+map_arr_width){if(c<j){c++;a.pos=thisPos}else if(c>=j){c=0;a.pos=nextPos;g++}a.repeatPathCnt=c;a.dir=7}else if(nextPos==thisPos-map_arr_width){if(c<j){c++;a.pos=thisPos}else if(c>=j){c=0;a.pos=nextPos;g++}a.repeatPathCnt=c;a.dir=1}else if(nextPos==thisPos+map_arr_width+1){if(c<j){c++;a.pos=thisPos}else if(c>=j){c=0;a.pos=nextPos;g++}a.repeatPathCnt=c;a.dir=8}else if(nextPos==thisPos-map_arr_width-1){if(c<j){c++;a.pos=thisPos}else if(c>=j){c=0;a.pos=nextPos;g++}a.repeatPathCnt=c;a.dir=0}a.pathCnt=g;d++;if(d>paceNum){d=0}if(g+1>=b.length){d=0}a.anID=d}else{}return a}function spriteMoveProcess(a){var b=new Array;var c=parseInt(a.attr("spriteID"));var d=parseInt(a.attr("spriteHeight"));var e=parseInt(a.attr("repeatPathCnt"));var f=a.attr("path").toString();var g=parseInt(a.attr("anID"));b=f.split(",");var h=parseInt(a.attr("pathCnt"));var i=b[h];var j=6;if(c<1e3){j=6}else if(c>=1e3&&c<2e3){j=2}else{j=4}if(i){thisPos=parseInt(b[h]);nextPos=parseInt(b[h+1]);if(nextPos==thisPos+map_arr_width-1){if(e<6){e++;a[0].pos=thisPos}else if(e>=6){e=0;a[0].pos=nextPos;h++}a.attr("repeatPathCnt",e);a.attr("direction",6)}else if(nextPos==thisPos-map_arr_width+1){if(e<6){e++;a[0].pos=thisPos}else if(e>=6){e=0;a[0].pos=nextPos;h++}a.attr("repeatPathCnt",e);a.attr("direction",2)}else if(nextPos==thisPos+1){if(e<2){e++;a[0].pos=thisPos}else if(e>=2){e=0;a[0].pos=nextPos;h++}a.attr("repeatPathCnt",e);a.attr("direction",5)}else if(nextPos==thisPos-1){if(e<2){e++;a[0].pos=thisPos}else if(e>=2){e=0;a[0].pos=nextPos;h++}a.attr("repeatPathCnt",e);a.attr("direction",3)}else if(nextPos==thisPos+map_arr_width){if(e<2){e++;a[0].pos=thisPos}else if(e>=2){e=0;a[0].pos=nextPos;h++}a.attr("repeatPathCnt",e);a.attr("direction",7)}else if(nextPos==thisPos-map_arr_width){if(e<2){e++;a[0].pos=thisPos}else if(e>=2){e=0;a[0].pos=nextPos;h++}a.attr("repeatPathCnt",e);a.attr("direction",1)}else if(nextPos==thisPos+map_arr_width+1){if(e<2){e++;a[0].pos=thisPos}else if(e>=2){e=0;a[0].pos=nextPos;h++}a.attr("repeatPathCnt",e);a.attr("direction",8)}else if(nextPos==thisPos-map_arr_width-1){if(e<2){e++;a[0].pos=thisPos}else if(e>=2){e=0;a[0].pos=nextPos;h++}a.attr("repeatPathCnt",e);a.attr("direction",0)}var k=loc2pos(parseInt(a[0].pos));var l=parseInt(a.attr("direction"));if(l==6){posX=k[0]-e*8;posY=k[1]-d}else if(l==2){posX=k[0]+e*8;posY=k[1]-d}else if(l==5){posX=k[0]+e*8;posY=k[1]-d+e*4}else if(l==3){posX=k[0]-e*8;posY=k[1]-d-e*4}else if(l==1){posX=k[0]+e*8;posY=k[1]-d-e*4}else if(l==7){posX=k[0]-e*8;posY=k[1]-d+e*4}else if(l==0){posX=k[0];posY=k[1]-d-e*8}else if(l==8){posX=k[0];posY=k[1]-d+e*8}else{posX=k[0];posY=k[1]-d;l=1}a.css("left",posX);posY=posY-screen_height_offset;a.css("top",posY);a.attr("pathCnt",h);var m=imgByDir(c,l);g++;if(g>j){g=0}if(h+1>=b.length){g=0}a.attr("src","res/spriteRes/"+c+"/"+m+"_"+g+".png");a.attr("anID",g)}return a}function spriteDir(a,b){a=parseInt(a);b=parseInt(b);var c=-1;if(b==a+1){c=5}else if(b==a-1){c=3}else if(b==a+map_arr_width){c=7}else if(b==a-map_arr_width){c=1}else if(b==a+map_arr_width+1){c=8}else if(b==a+map_arr_width-1){c=6}else if(b==a-map_arr_width+1){c=2}else if(b==a-map_arr_width-1){c=0}return c}function imgByDir(a,b){var c=a+"_10";if(b==0){c=a+"_11"}else if(b==1){c=a+"_10"}else if(b==2){c=a+"_10"}else if(b==3){c=a+"_11"}else if(b==5){c=a+"_12"}else if(b==6){c=a+"_13"}else if(b==7){c=a+"_13"}else if(b==8){c=a+"_12"}else{c=a+"_10"}return c}function imgByDir_cha(a,b){if(b==0){imgHead="lu"}else if(b==1){imgHead="ru"}else if(b==2){imgHead="ru"}else if(b==3){imgHead="lu"}else if(b==5){imgHead="rd"}else if(b==6){imgHead="ld"}else if(b==7){imgHead="ld"}else if(b==8){imgHead="rd"}else{imgHead="ru"}return imgHead}function htmlPosStrToNumber(a){return parseInt(a.substring(0,a.length-2))}function getNameLable(a,b){var c;if($("#"+a)[0])c=$("#"+a)[0];else{var c=document.createElement("DIV");c.setAttribute("id",a);c.setAttribute("align","center");c.style.position="absolute";c.style.width="5px";c.style.zIndex=1;c.style.fontSize="20px";if(a==user)c.innerHTML=getNameLableStyle_main(b);else c.innerHTML=getNameLableStyle(b)}return c}function getNameLableStyle(a){return"<br><div align='left' style='position:relative;left:-20px;top:-10px;width:70px;z-index:1;font-size:18px'><b>"+a+"</b></div>"}function getNameLableStyle_main(a){return"<br><div  align='left' style='width:10px;z-index:1'><img src='./res/icons/pos.png'></div>"}function getChatBubbleStyle(a){return"<p class='triangle-isosceles'>"+a+"</p>"}function update_la_content(a,b,c){var d=getNameLable(a,c);if(b==""){d.style.width="5px";if(a==user)d.innerHTML=getNameLableStyle_main(c);else d.innerHTML=getNameLableStyle(c)}else{d.style.width="135px";d.innerHTML=getChatBubbleStyle(b)+d.innerHTML;chatmsg="&nbsp<font color='blue'>"+c+":</font>"+b+"<br>"+chatmsg;$("lay").html(chatmsg)}}function removePlayerLable(a){var b=$("#"+a);b.remove()}function showPlayerLable(a){var b=$("#"+a);b.css("display","")}function hidePlayerLable(a){var b=$("#"+a);b.css("display","none")}function isBGImg(a){if(a==1||a==2){return true}return false}function isTerrainImg(a){if(a.indexOf("/10.png")!=-1)return true;return false}function getItemOffset(a){var b=a.toString().split("_");if(map_offset[a]){if(b.length>1){var c=b[0];var d=b[1];if(parseInt(d)==0)return map_offset[a];else return 0}else{return map_offset[a]}}else{return 0}}function point(a,b,c,d,e,f,g){var h=document.createElement("img");h.setAttribute("type","pointImg");h.src=f;h.id=g;h.style.position="absolute";h.style.left=a+"px";h.style.top=b+"px";h.style.width=c+"px";h.style.height=d+"px";h.style.zIndex=e;$("#lay0").append(h)}function createRect(a,b,c,d,e){clearRect();point(a,b,c-a,1,9999,"point.jpg","l1");point(c,b,1,d-b,9999,"point.jpg","l2");point(a,b,1,d-b,9999,"point.jpg","l3");point(a,d,c-a,1,9999,"point.jpg","l4")}function clearRect(){var a=$("IMG[type='pointImg']");for(var b=0;b<a.length;b++){var c=$("#"+a[b].id);c.remove()}}function setToOrder(a){a.sort(function(a,b){var c=loc2pos_absolute(a)[0];var d=loc2pos_absolute(b)[0];return c-d});return a}function setHashOrder(a){a.sort(function(a,b){var c=a.getPos();var d=b.getPos();return c-d});return a}function debugMsg(a){$("#debuginfo").val(a)}function uuidlet(){return((1+Math.random())*65536|0).toString(16).substring(1)}function getuuid(a){uuid_default_prefix=a;a=a||uuid_default_prefix||"";return a+uuidlet()+uuidlet()+"-"+uuidlet()+"-"+uuidlet()+"-"+uuidlet()+"-"+uuidlet()+uuidlet()+uuidlet()}function in_array(a,b){for(var c=0;c<b.length;c++){if(b[c]==a)return false}return true}function setProgress(val){eval('$( "#progressbar" ).progressbar({value:'+val+"})")}function isloaded(){if(version==2){$("#layLoading").remove()}else{var a=roomRes.loadedRec.getItem(main_img_id).loaded;var b=roomRes.mapResHash.getLength();if(b==itemNum&&a==spriteNum){$("#layLoading").remove();$("#lay0").css("display","");$("#startDiv").css("display","")}}}function getTransformProperty(a){var b=["transform","WebkitTransform","MozTransform","msTransform","OTransform"];var c;while(c=b.shift()){if(typeof a.style[c]!="undefined"){return c}}return false}function isActContent(a){if(a.startWith("&&"))return true;else if(unescape(a).startWith("&&"))return true;return false}function isClothContent(a){if(a.startWith(">>"))return true;else if(unescape(a).startWith(">>"))return true;return false}function getWidth(){xWidth=null;if(window.screen!=null)xWidth=window.screen.width;if(window.innerWidth!=null)xWidth=window.innerWidth;if(document.body!=null)xWidth=document.body.clientWidth;return xWidth}function getHeight(){xHeight=null;if(window.screen!=null)xHeight=window.screen.height;if(window.innerHeight!=null)xHeight=window.innerHeight;if(document.body!=null)xHeight=document.body.clientHeight;return xHeight}function ImagePreloader(a,b,c,d,e){this.pObj=e;this.nLoaded=0;this.nProcessed=0;this.aImages=[];this.nImages=a.length+b.length+c.length+d.length;for(var f=0;f<a.length;f++)this.preload(a[f],"ld");for(var f=0;f<b.length;f++)this.preload(b[f],"rd");for(var f=0;f<c.length;f++)this.preload(c[f],"lu");for(var f=0;f<d.length;f++)this.preload(d[f],"ru")}function extend(a,b){var c=a.prototype;a.prototype=new b;a.prototype.constructor=a;for(var d in c){a.prototype[d]=c[d]}a.supr=b}function BasePart(a,b,c,d,e,f,g,h){this.baseX=a;this.baseY=b;this.rotX=c;this.rotY=d;this.rotX1=c;this.rotY1=d;this.degree=e;this.name=g;this.img=f;this.orient=h;this.offx=0;this.offy=0;this.disp=1}function BodyPart(a,b,c,d,e,f,g,h){BodyPart.supr.call(this,a,b,c,d,e,f,g,h);this.accessories=new Array;if(h=="lu"||h=="ru"){this.isUPed=true}else{this.isUPed=false}}function Accessories(a,b,c,d,e,f,g,h){Accessories.supr.call(this,a,b,c,d,e,f,g,h)}function createTwoDimensionArray(a,b){var c=new Array(a.length);for(var d=0;d<a.length;d++){c[a[d]]=new Array(b)}return c}function bodyPos(){var a=["lLeg","lArm","lLimb","body","rLeg","rArm","rLimb","head"];this.pos_arr_up=createTwoDimensionArray(a,4);this.pos_arr_dn=createTwoDimensionArray(a,4);this.up_dn_offset=createTwoDimensionArray([0,1,2,3,4,5,6,7],2);this.up_dn_offset_name=createTwoDimensionArray(a,2);this.pos_arr_dn["lLeg"]["bx_off"]=13;this.pos_arr_dn["lLeg"]["by_off"]=83;this.pos_arr_dn["lLeg"]["rx_off"]=8;this.pos_arr_dn["lLeg"]["ry_off"]=4;this.pos_arr_dn["lArm"]["bx_off"]=-1;this.pos_arr_dn["lArm"]["by_off"]=74;this.pos_arr_dn["lArm"]["rx_off"]=14;this.pos_arr_dn["lArm"]["ry_off"]=0;this.pos_arr_dn["lLimb"]["bx_off"]=11;this.pos_arr_dn["lLimb"]["by_off"]=65;this.pos_arr_dn["lLimb"]["rx_off"]=14;this.pos_arr_dn["lLimb"]["ry_off"]=0;this.pos_arr_dn["body"]["bx_off"]=16;this.pos_arr_dn["body"]["by_off"]=62;this.pos_arr_dn["body"]["rx_off"]=12;this.pos_arr_dn["body"]["ry_off"]=0;this.pos_arr_dn["rLeg"]["bx_off"]=24;this.pos_arr_dn["rLeg"]["by_off"]=88;this.pos_arr_dn["rLeg"]["rx_off"]=8;this.pos_arr_dn["rLeg"]["ry_off"]=0;this.pos_arr_dn["rArm"]["bx_off"]=42;this.pos_arr_dn["rArm"]["by_off"]=74;this.pos_arr_dn["rArm"]["rx_off"]=0;this.pos_arr_dn["rArm"]["ry_off"]=0;this.pos_arr_dn["rLimb"]["bx_off"]=32;this.pos_arr_dn["rLimb"]["by_off"]=65;this.pos_arr_dn["rLimb"]["rx_off"]=0;this.pos_arr_dn["rLimb"]["ry_off"]=0;this.pos_arr_dn["head"]["bx_off"]=0;this.pos_arr_dn["head"]["by_off"]=0;this.pos_arr_dn["head"]["rx_off"]=32;this.pos_arr_dn["head"]["ry_off"]=57;this.pos_arr_up["lLeg"]["bx_off"]=14;this.pos_arr_up["lLeg"]["by_off"]=87;this.pos_arr_up["lLeg"]["rx_off"]=8;this.pos_arr_up["lLeg"]["ry_off"]=4;this.pos_arr_up["lArm"]["bx_off"]=1;this.pos_arr_up["lArm"]["by_off"]=72;this.pos_arr_up["lArm"]["rx_off"]=14;this.pos_arr_up["lArm"]["ry_off"]=0;this.pos_arr_up["lLimb"]["bx_off"]=12;this.pos_arr_up["lLimb"]["by_off"]=63;this.pos_arr_up["lLimb"]["rx_off"]=14;this.pos_arr_up["lLimb"]["ry_off"]=0;this.pos_arr_up["body"]["bx_off"]=16;this.pos_arr_up["body"]["by_off"]=62;this.pos_arr_up["body"]["rx_off"]=12;this.pos_arr_up["body"]["ry_off"]=0;this.pos_arr_up["rLeg"]["bx_off"]=24;this.pos_arr_up["rLeg"]["by_off"]=82;this.pos_arr_up["rLeg"]["rx_off"]=8;this.pos_arr_up["rLeg"]["ry_off"]=4;this.pos_arr_up["rArm"]["bx_off"]=39;this.pos_arr_up["rArm"]["by_off"]=71;this.pos_arr_up["rArm"]["rx_off"]=0;this.pos_arr_up["rArm"]["ry_off"]=0;this.pos_arr_up["rLimb"]["bx_off"]=30;this.pos_arr_up["rLimb"]["by_off"]=62;this.pos_arr_up["rLimb"]["rx_off"]=0;this.pos_arr_up["rLimb"]["ry_off"]=0;this.pos_arr_up["head"]["bx_off"]=0;this.pos_arr_up["head"]["by_off"]=0;this.pos_arr_up["head"]["rx_off"]=32;this.pos_arr_up["head"]["ry_off"]=57;this.up_dn_offset[0][0]=this.pos_arr_up["lLeg"]["bx_off"]-this.pos_arr_dn["lLeg"]["bx_off"];this.up_dn_offset[0][1]=this.pos_arr_up["lLeg"]["by_off"]-this.pos_arr_dn["lLeg"]["by_off"];this.up_dn_offset[1][0]=this.pos_arr_up["lArm"]["bx_off"]-this.pos_arr_dn["lArm"]["bx_off"];this.up_dn_offset[1][1]=this.pos_arr_up["lArm"]["by_off"]-this.pos_arr_dn["lArm"]["by_off"];this.up_dn_offset[2][0]=this.pos_arr_up["lLimb"]["bx_off"]-this.pos_arr_dn["lLimb"]["bx_off"];this.up_dn_offset[2][1]=this.pos_arr_up["lLimb"]["by_off"]-this.pos_arr_dn["lLimb"]["by_off"];this.up_dn_offset[3][0]=this.pos_arr_up["body"]["bx_off"]-this.pos_arr_dn["body"]["bx_off"];this.up_dn_offset[3][1]=this.pos_arr_up["body"]["by_off"]-this.pos_arr_dn["body"]["by_off"];this.up_dn_offset[4][0]=this.pos_arr_up["rLeg"]["bx_off"]-this.pos_arr_dn["rLeg"]["bx_off"];this.up_dn_offset[4][1]=this.pos_arr_up["rLeg"]["by_off"]-this.pos_arr_dn["rLeg"]["by_off"];this.up_dn_offset[5][0]=this.pos_arr_up["rArm"]["bx_off"]-this.pos_arr_dn["rArm"]["bx_off"];this.up_dn_offset[5][1]=this.pos_arr_up["rArm"]["by_off"]-this.pos_arr_dn["rArm"]["by_off"];this.up_dn_offset[6][0]=this.pos_arr_up["rLimb"]["bx_off"]-this.pos_arr_dn["rLimb"]["bx_off"];this.up_dn_offset[6][1]=this.pos_arr_up["rLimb"]["by_off"]-this.pos_arr_dn["rLimb"]["by_off"];this.up_dn_offset[7][0]=this.pos_arr_up["head"]["bx_off"]-this.pos_arr_dn["head"]["bx_off"];this.up_dn_offset[7][1]=this.pos_arr_up["head"]["by_off"]-this.pos_arr_dn["head"]["by_off"];this.up_dn_offset_name["lLeg"]=this.up_dn_offset[0];this.up_dn_offset_name["lArm"]=this.up_dn_offset[1];this.up_dn_offset_name["lLimb"]=this.up_dn_offset[2];this.up_dn_offset_name["body"]=this.up_dn_offset[3];this.up_dn_offset_name["rLeg"]=this.up_dn_offset[4];this.up_dn_offset_name["rArm"]=this.up_dn_offset[5];this.up_dn_offset_name["rLimb"]=this.up_dn_offset[6];this.up_dn_offset_name["head"]=this.up_dn_offset[7]}function human(a,b){this.inistr=b;this.dn_up_off=base_pos.getUpDnOffset();this.overlap_order_dn=[0,1,2,4,3,5,6,7];this.overlap_order_up=[4,5,6,0,3,1,2,7];this.humanObj=[];this.loadedImg=[];this.aniArr=[];this.actArr=[];this.aniLen=0;this.actLen=0;this.aniPoint=0;this.actPoint=0;this.orient=a;this.px=-20;this.py=-20;this.ss=null;this.offx=0;this.offy=0;this.loadRes();this.isLoaded=0}function scrollScr(a,b){if(isScrMoving==1||map_arr_width<32)return;repeat++;var c=$("#canvas").css("backgroundPosition");var d=parseInt(c.split(" ")[0]);var e=parseInt(c.split(" ")[1]);if(b<64){screen_height_offset-=60;e+=60}else if(b>450){screen_height_offset+=60;e-=60}if(a<92){half_bg_width+=64;d+=64}else if(a>920){half_bg_width-=64;d-=64}ix=half_bg_width-tile_width/2;iy=0-screen_height_offset;ca.setMap(ix,iy);ca.mapReload();d=d+"px";e=e+"px";var f=d+" "+e;$("#canvas").css("backgroundPosition",f);if(repeat<2)setTimeout(function(){scrollScr(a,b)},300)}function endMSMoveEventFunction(a){tx=0;ty=0;sx=0;sy=0;isMouseDown=0;setTimeout(function(){isScrMoving=0},300)}function endMSMoveEventFunction1(a){var b=window.event||a;if(b.clientY-4>=bg_height||b.clientX-4>=bg_width||b.clientX-4<=0||b.clientY-4<=0){tx=0;ty=0;sx=0;sy=0;isMouseDown=0;setTimeout(function(){isScrMoving=0},300)}}function moveMSEventFunction(a){var b,c,d;var e=window.event||a;if(e.clientY-4>=bg_height||e.clientX-4>=bg_width||e.clientX-4<=0||e.clientY-4<=0){endMSMoveEventFunction(a);return}if(isMouseDown==1){isScrMoving=1;mapScreenMove(e.clientX,e.clientY)}return false}function mapScreenMove(a,b){var c=(new Date).getTime()-dura;if(c<scr_scroll_speed)return false;dura=(new Date).getTime();var d,e,f;if(sx==0&&sy==0){sx=a;sy=b}else{d=parseInt((a-sx)/12);e=parseInt((b-sy)/12);pageElementMove(d,e);var g=$("#canvas").css("backgroundPosition");var h=parseInt(g.split(" ")[0]);var i=parseInt(g.split(" ")[1]);half_bg_width+=d;h+=d;m_offx+=d;screen_height_offset-=e;i+=e;m_offy+=e;h=h+"px";i=i+"px";var j=h+" "+i;$("#canvas").css("backgroundPosition",j);ix=half_bg_width-tile_width/2;iy=0-screen_height_offset;ca.setMap(ix,iy);ca.mapReload()}}function endMoveEventFunction(a){a.preventDefault();tx=0;ty=0;sx=0;sy=0}function moveEventFunction(a){a.preventDefault();if(a.touches){var b=getCoords(a.touches[0]);if(b.y-4>=bg_height){endMSMoveEventFunction(a);return}mapScreenMove(b.x,b.y)}return false}function vertAlign(a){var b=a.height;var c=parseInt($(a.parentNode).css("height"));a.style.marginTop=(c-b)/2+"px"}var OtherSprites=function(a,b){this.myHash=new Hash;this.mainSprite=null;this.Ordered=new Array};OtherSprites.prototype={set_sprite:function(a,b){this.myHash.setItem(a,b)},get_sprite:function(a){return this.myHash.getItem(a)},up_sprite_pos:function(a,b){},up_sprite_sid:function(a,b){},up_sprite_path:function(a,b){},up_sprite_pathCnt:function(a,b){},intervalOthersChatMsg:function(){var a;var b;for(var c in this.myHash.items){b=this.myHash.items[c].getSayTime();if(b>-1){b--;this.myHash.items[c].setSayTime(b)}else{update_la_content(c,"",this.myHash.items[c].getDispName())}}},get_other_cid_str:function(){var a="";for(var b in this.myHash.items){a+="||"+b+":"+this.myHash.items[b].getCid()}a=a.substring(2);return a},get_req_str:function(){var a="";for(var b in this.myHash.items){a+="||"+b+":"+this.myHash.items[b].getSID()}a=a.substring(2);return a},appendOtherLables:function(){var a,b,c;for(var d in this.myHash.items){a=this.myHash.items[d].getPosX();b=this.myHash.items[d].getPosY();c=this.myHash.items[d].getDispName();if(a<bg_width){var e=getNameLable(d,c);var f=parseInt(htmlPosStrToNumber(e.style.width)/2)+20;var g=parseInt(this.myHash.items[d].getWidth()/2);e.style.left=a-f+g+canvas_offx+"px";e.style.top=b-$("#"+d).height()-60+(canvas_offy-30)+"px";$("#lay0").append(e)}}},get_length:function(){return this.myHash.getLength()},get_max_path_length:function(){var a=-1;var b;var c;for(var d in this.myHash.items){b=this.myHash.items[d].getPathVal();c=b.split(",");if(c.length>a)a=c.length}return a},get_max_act_length:function(){var a=-1;var b;var c;for(var d in this.myHash.items){b=this.myHash.items[d].getActVal();if(b!==undefined){c=b.split("&&");if(c.length>a)a=c.length}}return a},is_exist:function(a){return this.myHash.hasItem(a)},set_sprites_path:function(){var a;var b;for(var c in this.myHash.items){a=this.myHash.items[c];if(a.getPathVal()==""&&a.getPathQueCnt()>0){b=a.pathQue2Str();var d=b.split(",")[0];if(a.pos!=d)b=a.pos+","+b;a.setPathVal(b);a.setPathCntVal(0);this.set_sprite(c,a)}}},move_step:function(){var a=true;var b=true;var c=true;var d;var e;for(var f in this.myHash.items){e=0;d=this.myHash.items[f];if(d.path!=""){e=1;var g=spriteMoveProcess_ht5(d);var h=g.path.toString();var i=h.split(",");b=g.getPathCntVal()+1==i.length;if(b){g.path=""}g.hm.setAniFrame(g.anID);this.set_sprite(f,g);a=b&a;this.set_endflag(a)}else{this.set_endflag(true)}if(d.actStr!=""&&e==0){d.hm.setActFrame(d.actCnt);d.actCnt++;var j=d.actStr.toString();var k=j.split("&&");c=this.myHash.items[f].actCnt==k.length;if(c){d.actCnt=0;d.actStr=""}this.set_sprite(f,d);a=c&a;this.set_act_endflag(a)}else{this.set_act_endflag(true)}}},removePlayerImg:function(a){var b=a.split("||");for(var c in this.myHash.items){var d=this.myHash.getItem(c);if(jQuery.inArray(c,b)==-1){this.myHash.removeItem(c);removePlayerLable(c)}}},remove_user:function(a){this.myHash.removeItem(a);removePlayerLable(a)},set_endflag:function(a){this.isEnd=a},set_act_endflag:function(a){this.isActEnd=a},get_endflag:function(){return this.isEnd&this.isActEnd},get_act_endflag:function(){return this.isActEnd},clear_ordered_arr:function(){this.Ordered=new Array},load_to_arr:function(a){this.Ordered[this.Ordered.length]=a},disp_ordered:function(){this.Ordered=setHashOrder(this.Ordered);for(var a=0;a<this.Ordered.length;a++){this.Ordered[a].draw()}},draw_all:function(a){for(var b in this.myHash.items){this.load_to_arr(this.myHash.items[b])}this.disp_ordered()},draw_others_before:function(a){for(var b in this.myHash.items){if(this.myHash.items[b].getPos()<=a[0].pos){this.load_to_arr(this.myHash.items[b])}}this.disp_ordered()},draw_others_middle:function(a,b){var c;for(var d in this.myHash.items){c=this.myHash.items[d].getPos();if(a[b]&&c>=a[b].pos&&c<a[b+1].pos){this.load_to_arr(this.myHash.items[d])}}this.disp_ordered()},draw_others_last:function(a){var b;for(var c in this.myHash.items){b=this.myHash.items[c].getPos();if(a[a.length-1]&&this.myHash.items[c]){if(b>=a[a.length-1].pos){this.load_to_arr(this.myHash.items[c])}}}this.disp_ordered()}};var mvArr=Array();var mvArr_cnt=0;var isMapLoading=0;var Canvas=function(){this.mainSprite=null};Canvas.prototype={begin:function(){},stop:function(){clearInterval(this.interval)},setMap:function(a,b){var c,d,e,f,g;var h,i;var j,k,l;mvArr_cnt=0;for(var m=0;m<map_arr_width;m++){h=a-m*(tile_width/2);i=b+m*tile_height_offset;for(var n=0;n<map_arr_height;n++){j=map_all[m*map_arr_width+n].toString();k=j.split("|");for(var o=0;o<k.length;o++){e=h+n*(tile_width/2);f=i+n*tile_height_offset;l=k[o];if(!isBGImg(l)){c="bg"+l;d=l;e=e-getItemOffset(l);e=e;f=f+tile_height;g=m*map_arr_width+n;var p=new Object;p.px=e;p.py=f;p.pos=g;p.id=c;p.key=d;mvArr[mvArr_cnt]=p;mvArr_cnt++}}}}},editMapReload:function(){ctx.clearRect(0,0,bg_width,bg_height);for(var a=0;a<mvArr.length;a++){if(mvArr[a]){try{var b=roomRes.get_map_img(mvArr[a].key);ctx.drawImage(b,mvArr[a].px,mvArr[a].py-b.height)}catch(c){continue}}}},mapReload:function(){if(isMapLoading==1)return;isMapLoading=1;ctx.clearRect(0,0,bg_width,bg_height);otherSprites.clear_ordered_arr();if(this.mainSprite&&(mvArr.length==0||this.mainSprite.pos<=mvArr[0].pos)){otherSprites.load_to_arr(this.mainSprite)}if(mvArr.length>0)otherSprites.draw_others_before(mvArr);for(var a=0;a<mvArr.length;a++){if(mvArr[a]){try{var b=roomRes.get_map_img(mvArr[a].key);if(mvArr[a].key!=10)ctx.drawImage(b,mvArr[a].px,mvArr[a].py-b.height)}catch(c){continue}}otherSprites.clear_ordered_arr();if(mvArr[a]&&mvArr[a+1]){if(this.mainSprite&&this.mainSprite.pos>=mvArr[a].pos&&this.mainSprite.pos<mvArr[a+1].pos){otherSprites.load_to_arr(this.mainSprite)}if(mvArr.length>0)otherSprites.draw_others_middle(mvArr,a)}}otherSprites.clear_ordered_arr();if(this.mainSprite&&(mvArr.length==0||this.mainSprite.pos>=mvArr[a-1].pos)){otherSprites.load_to_arr(this.mainSprite)}if(mvArr.length>0)otherSprites.draw_others_last(mvArr);else if(mvArr.length==0)otherSprites.draw_all(mvArr);this.appendMainLable(user,myname);otherSprites.appendOtherLables();this.render();isMapLoading=0},render:function(){ctx1.clearRect(0,0,bg_width,bg_height);ctx1.drawImage(m_canvas,0,0)},setMainSprite:function(a){this.mainSprite=a},appendMainLable:function(a,b){var c,d;c=mainsprite.getPosX();d=mainsprite.getPosY();if(c<bg_width){var e=getNameLable(a,b);var f=parseInt(htmlPosStrToNumber(e.style.width)/2)+32;var g=parseInt(mainsprite.getWidth()/2);e.style.left=c-f+g+canvas_offx+"px";e.style.top=d-$("#"+user).height()-60+(canvas_offy-30)+"px";$("#lay0").append(e)}},init:function(){if(ctx){this.mapReload()}},mapEditInit:function(){if(ctx){this.editMapReload()}}};var Sprite=function(){this.px=0;this.py=0;this.actionType="walk";this.path="";this.path_que=[]};Sprite.prototype={draw:function(){var a;var b;var c=1;var d=loc2pos_absolute(this.pos);a=d[0]+parseInt(this.repeatPathCnt*c)*16;b=d[1]-this.height;var e=imgByDir_cha(this.spriteID,this.dir);var f,g;if(this.dir==6){f=d[0]-parseInt(this.repeatPathCnt)*8;g=d[1]-this.height}else if(this.dir==2){f=d[0]+parseInt(this.repeatPathCnt)*8;g=d[1]-this.height}else if(this.dir==5){f=d[0]+parseInt(this.repeatPathCnt)*8;g=d[1]-this.height+parseInt(this.repeatPathCnt)*4}else if(this.dir==3){f=d[0]-parseInt(this.repeatPathCnt)*8;g=d[1]-this.height-parseInt(this.repeatPathCnt)*4}else if(this.dir==1){f=d[0]+parseInt(this.repeatPathCnt)*8;g=d[1]-this.height-parseInt(this.repeatPathCnt)*4}else if(this.dir==7){f=d[0]-parseInt(this.repeatPathCnt)*8;g=d[1]-this.height+parseInt(this.repeatPathCnt)*4}else if(this.dir==0){f=d[0];g=d[1]-this.height-parseInt(this.repeatPathCnt)*8}else if(this.dir==8){f=d[0];g=d[1]-this.height+parseInt(this.repeatPathCnt)*8}else{f=d[0];g=d[1]-this.height}f=f-(this.width-half_tile_width)-8+40;g=g-screen_height_offset+80;this.px=f;this.py=g;this.drawSprite(e,f,g)},drawSprite:function(a,b,c){try{if(this.hm.isLoaded===1){if(b<bg_width){this.hm.setHMPos(b,c);if(this.path!="")this.hm.setDir(a);this.hm.drawFrame(1);showPlayerLable(this.user)}else{hidePlayerLable(this.user)}}}catch(d){alert(d)}},setDispName:function(a){this.dispName=a},getDispName:function(){return this.dispName},setSpriteID:function(a){this.spriteID=a},setImg:function(a){this.spriteID=a;this.img=a+"_10";this.anID=0;this.dir=1;this.repeatPathCnt=0;this.content="";this.cid=-1;this.sayTime=-1;this.actCnt=0;this.actStr=""},setUser:function(a){this.user=a},setHuman:function(a){this.hm=a},setContent:function(a){this.content=a},setWidth:function(a){this.width=a},getWidth:function(){return this.width},setHeight:function(a){this.height=a},setCid:function(a){this.cid=a},getCid:function(){return this.cid},setSayTime:function(a){this.sayTime=a},getSayTime:function(){return this.sayTime},getPosX:function(){return this.px},getPosY:function(){return this.py},setPathVal:function(a){this.path=a},getPathVal:function(){return this.path},setPathCntVal:function(a){this.pathCnt=a},getPathCntVal:function(){return this.pathCnt},setSID:function(a){this.sid=a},getSID:function(){return this.sid},setPos:function(a){this.pos=a},getPos:function(){return this.pos},setRepeatPathCnt:function(a){this.repeatPathCnt=a},getRepeatPathCnt:function(){return this.repeatPathCnt},setActCntVal:function(a){this.actCnt=a},setActStr:function(a){this.hm.action(a);this.actStr=a.substring(2)},getActVal:function(){return this.actStr},getPathQueCnt:function(){return this.path_que.length},pathQue2Str:function(){var a="";var b;var c;for(var d=0;d<this.path_que.length;d++){b=this.path_que[d].split(",");if(d>0){c=this.path_que[d-1].split(",");if(c[c.length-1]==b[0])b=b.slice(1,b.length)}a=a+b+",";a=a.replace(/,,/g,",")}a=a.substring(0,a.length-1);this.clearPathQue();return a},setPathQue:function(a){this.path_que[this.path_que.length]=a},clearPathQue:function(a){this.path_que=[]},setPath:function(){this.actionType="walk";if(this.repeatPathCnt==0){var a=path_cal.Astar(target_pos,this.pos);target_pos=0;if(pathEnd==false){var b=new Array;var c=this.path.toString();var d=parseInt(this.pathCnt);b=c.split(",");var e=b.slice(0,d);if(e.length>0){var f=this.user+":0:"+e+":1001";var g="PA";s1.socket.send(g+f)}}this.path=a;this.pathCnt=0;this.repeatPathCnt=0;pathEnd=false}},login:function(){var a=this.convert_inistr(inistr_main);var b=this.user+":0:"+default_pos+":"+this.dispName+":"+a;var c="LI";s1.socket.send(c+b);pathEnd=true},convert_inistr:function(a){a=a.replaceAll("||","~~");a=a.replaceAll(":",";");return a},move_main_player:function(){var a=0;var b;if(mainsprite.path!=""){a=1;if(target_pos!=0&&mainsprite.repeatPathCnt==0){mainsprite.setPath()}else{var c=spriteMoveProcess_ht5(mainsprite);c.hm.setAniFrame(c.anID);ca.setMainSprite(c);var d=c.path.toString();var e=d.split(",");if(c.getPathCntVal()+1>=e.length){mainsprite.path="";var f=this.user+":0:"+e+":"+this.dispName;var g;if(firstCloSend){f=f+":"+this.convert_inistr(inistr_main);firstCloSend=false}var h="PA";s1.socket.send(h+f);pathEnd=true;repeat=0}}}if(mainsprite.actStr!=""&&a==0){mainsprite.hm.setActFrame(mainsprite.actCnt);mainsprite.actCnt++;var i=mainsprite.actStr.toString();var j=i.split("&&");b=mainsprite.actCnt==j.length;if(b){mainsprite.actCnt=0;mainsprite.actStr=""}}}};var cycleID;var count=0;var i_oID;var otherSprites;var chatmsg="";var firstCloSend=false;var Path_Finding=function(){this.UPDW_SPACE=map_arr_width;this.LFRT_SPACE=map_arr_height;this.map_all=new Array;this.rhombus_distance=18;this.rhombus_lr_distance=32;this.rhombus_ud_distance=16};Path_Finding.prototype={Path_Finding_init:function(a){this.map_all=a},getXY:function(a){var b=new Array(2);b[0]=parseInt(a/this.LFRT_SPACE);b[1]=a%this.LFRT_SPACE;return b},getDistance:function(a,b){var c=-1;var d=this.getXY(a);var e=this.getXY(b);c=Math.abs(d[0]-e[0])+Math.abs(d[1]-e[1]);return c},isPassable:function(a){if(is_terrain_passable(a))return false;else return true},isInClose:function(a,b,c){for(var d=0;d<a.length;d++){if(d>=b)break;if(a[d][0]==c)return true}return false},retNoInArr:function(a,b,c){for(var d=0;d<=b-1;d++){if(a[d][0]==c&&a[d][5]==0)return d}return-1},retKeyInOpen:function(a,b){var c=99999;var d=-1;for(var e=0;e<=b-1;e++){if(a[e][4]<c&&a[e][5]==0){c=a[e][4];d=e}}return d},dispPath:function(a,b,c,d){for(var e=0;e<a.length;e++){if(e>b)break;if(a[e][0]==c){d.push(c);this.dispPath(a,b,a[e][1],d)}}},getNear:function(a,b,c,e,f){u=new Array;d=new Array;l=new Array;r=new Array;ul=new Array;ur=new Array;dl=new Array;dr=new Array;var g,h,i,j;var k,m,n,o;g=a-this.UPDW_SPACE>=0?a-this.UPDW_SPACE:-1;h=a+this.UPDW_SPACE<=this.UPDW_SPACE*this.UPDW_SPACE?a+this.UPDW_SPACE:-1;i=a-1>=0?a-1:-1;j=a+1<=this.UPDW_SPACE*this.UPDW_SPACE?a+1:-1;if(g!=-1&&this.isPassable(g)&&!this.isInClose(e,f,g)){u=new Array(6);u[0]=g;u[1]=a;u[2]=b+this.rhombus_distance;u[3]=this.getDistance(g,c);u[4]=u[2]+u[3];u[5]=0}if(h!=-1&&this.isPassable(h)&&!this.isInClose(e,f,h)){d=new Array(6);d[0]=h;d[1]=a;d[2]=b+this.rhombus_distance;d[3]=this.getDistance(h,c);d[4]=d[2]+d[3];d[5]=0}if(i!=-1&&this.isPassable(i)&&!this.isInClose(e,f,i)){l=new Array(6);l[0]=i;l[1]=a;l[2]=b+this.rhombus_distance;l[3]=this.getDistance(i,c);l[4]=l[2]+l[3];l[5]=0}if(j!=-1&&this.isPassable(j)&&!this.isInClose(e,f,j)){r=new Array(6);r[0]=j;r[1]=a;r[2]=b+this.rhombus_distance;r[3]=this.getDistance(j,c);r[4]=r[2]+r[3];r[5]=0}if(a%this.UPDW_SPACE==0)l="";if((a+1)%this.UPDW_SPACE==0)r="";k=a-this.UPDW_SPACE-1>=0?a-this.UPDW_SPACE-1:-1;m=a-this.UPDW_SPACE+1>=0?a-this.UPDW_SPACE+1:-1;n=a+this.UPDW_SPACE-1<=this.UPDW_SPACE*this.UPDW_SPACE?a+this.UPDW_SPACE-1:-1;o=a+this.UPDW_SPACE+1<=this.UPDW_SPACE*this.UPDW_SPACE?a+this.UPDW_SPACE+1:-1;if(k!=-1&&u!=""&&l!=""&&this.isPassable(k)&&!this.isInClose(e,f,k)){ul=new Array(6);ul[0]=k;ul[1]=a;ul[2]=b+this.rhombus_ud_distance;ul[3]=this.getDistance(k,c);ul[4]=ul[2]+ul[3];ul[5]=0}if(m!=-1&&u!=""&&r!=""&&this.isPassable(m)&&!this.isInClose(e,f,m)){ur=new Array(6);ur[0]=m;ur[1]=a;ur[2]=b+this.rhombus_lr_distance;ur[3]=this.getDistance(m,c);ur[4]=ur[2]+ur[3];ur[5]=0}if(n!=-1&&d!=""&&l!=""&&this.isPassable(n)&&!this.isInClose(e,f,n)){dl=new Array(6);dl[0]=n;dl[1]=a;dl[2]=b+this.rhombus_lr_distance;dl[3]=this.getDistance(n,c);dl[4]=dl[2]+dl[3];dl[5]=0}if(o!=-1&&d!=""&&r!=""&&this.isPassable(o)&&!this.isInClose(e,f,o)){dr=new Array(6);dr[0]=o;dr[1]=a;dr[2]=b+this.rhombus_ud_distance;dr[3]=this.getDistance(o,c);dr[4]=dr[2]+dr[3];dr[5]=0}var p=Array(u,d,l,r,ul,ur,dl,dr);return p},Astar:function(a,b){var c=new Array(6);var d=0;var e=0;var f=false;var g=0;var h=[];c[0]=a;c[1]=-1;c[2]=0;c[3]=this.getDistance(a,b);c[4]=c[2]+c[3];c[5]=0;var i=createTwoDimensionArray(this.UPDW_SPACE*this.LFRT_SPACE,6);i[d++]=c;var j=createTwoDimensionArray(this.UPDW_SPACE*this.LFRT_SPACE,6);while(!f){var k=i[g];var l=this.getNear(k[0],k[2],b,j,e);i[g][5]=1;for(var m=0;m<l.length;m++){if(l[m]=="")continue;var n=l[m][0];var o=this.retNoInArr(i,d,n);var p=this.retNoInArr(j,e,n);if(o==-1&&p==-1){i[d++]=l[m]}if(o!=-1){if(l[m][4]<i[o][4]){i[o]=l[m]}}}j[e++]=i[g];if(i[g][0]==b)f=true;else g=this.retKeyInOpen(i,d)}this.dispPath(j,e,b,h);return h}};String.prototype.startWith=function(a){var b=new RegExp("^"+a);return b.test(this)};String.prototype.startWith=function(a){var b=new RegExp("^"+a);return b.test(this)};String.prototype.replaceAll=function(a,b){var c=new RegExp(a.replace(/([\(\)\[\]\{\}\^\$\+\-\*\?\.\"\'\|\/\\])/g,"\\$1"),"ig");return this.replace(c,b)};var ResLoad=function(){this.mapResHash=new Hash;this.spriteResHash=new Hash;this.loadedRec=new Hash;this.loadedMapImgCnt=0;this.loadedSpriteImgCnt=0};ResLoad.prototype={map_res_load:function(a,b){this.loadedMapImgCnt=0;var c,d,e;for(var f=0;f<a.length;f++){c=a[f].toString();d=c.split("|");for(var g=0;g<d.length;g++){e=d[g];if(!isBGImg(e)){var h=e;if(!this.mapResHash.hasItem(h)){var i=new Image;var j=h.split("_")[0];i.src="res/mapRes/up/"+j+"/"+h+".png";i.onload=this.load_map_count_up;this.mapResHash.setItem(h,i);if(b==1&&h.split("_")[1]&&h.split("_")[1]==0){i.src="res/mapRes/up/"+j+"/"+h.split("_")[0]+".png";i.onload=this.load_map_count_up;this.mapResHash.setItem(h.split("_")[0],i)}}}}}},sprite_res_load:function(a,b,c){this.loadedSpriteImgCnt=0;var d=new Object;d.total=b*c;d.loaded=0;this.loadedRec.setItem(a,d);for(var e=0;e<b;e++){for(var f=0;f<c;f++){var g=a+"_1"+e+"_"+f;var h=new Image;h.src="res/spriteRes/"+a+"/"+g+".png";h.onload=this.load_sprite_count_up(a);this.spriteResHash.setItem(g,h)}}},get_sprite_img:function(a){var b=a;return this.spriteResHash.getItem(b)},load_map_count_up:function(){},load_sprite_count_up:function(a){var b=roomRes.loadedRec.getItem(a);b.loaded=b.loaded+1;roomRes.loadedRec.setItem(a,b);isloaded()},isSpriteLoaded:function(a){var b=roomRes.loadedRec.getItem(a);if(b&&b.loaded==b.total)return true;return false},get_map_img:function(a){var b=a;return this.mapResHash.getItem(b)},set_sprite:function(a){},get_sprite:function(){}};var BrowserDetect={init:function(){this.browser=this.searchString(this.dataBrowser)||"An unknown browser";this.version=this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion)||"an unknown version";this.OS=this.searchString(this.dataOS)||"an unknown OS"},searchString:function(a){for(var b=0;b<a.length;b++){var c=a[b].string;var d=a[b].prop;this.versionSearchString=a[b].versionSearch||a[b].identity;if(c){if(c.indexOf(a[b].subString)!=-1)return a[b].identity}else if(d)return a[b].identity}},searchVersion:function(a){var b=a.indexOf(this.versionSearchString);if(b==-1)return;return parseFloat(a.substring(b+this.versionSearchString.length+1))},dataBrowser:[{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",identity:"OmniWeb"},{string:navigator.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{prop:window.opera,identity:"Opera"},{string:navigator.vendor,subString:"iCab",identity:"iCab"},{string:navigator.vendor,subString:"KDE",identity:"Konqueror"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{string:navigator.vendor,subString:"Camino",identity:"Camino"},{string:navigator.userAgent,subString:"Netscape",identity:"Netscape"},{string:navigator.userAgent,subString:"MSIE",identity:"Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Gecko",identity:"Mozilla",versionSearch:"rv"},{string:navigator.userAgent,subString:"Mozilla",identity:"Netscape",versionSearch:"Mozilla"}],dataOS:[{string:navigator.platform,subString:"Win",identity:"Windows"},{string:navigator.platform,subString:"Mac",identity:"Mac"},{string:navigator.userAgent,subString:"iPhone",identity:"iPhone/iPod"},{string:navigator.platform,subString:"Linux",identity:"Linux"}]};BrowserDetect.init();ImagePreloader.prototype.preload=function(a,b){var c=new Image;var d=a.split("/");d=d[d.length-1];d=d.split(".")[0];this.aImages[b+"_"+d]=c;c.onload=ImagePreloader.prototype.onload;c.onerror=ImagePreloader.prototype.onerror;c.onabort=ImagePreloader.prototype.onabort;c.oImagePreloader=this;c.bLoaded=false;c.src=a};ImagePreloader.prototype.onComplete=function(){this.nProcessed++;if(this.nProcessed==this.nImages){this.pObj.startUP()}};ImagePreloader.prototype.onload=function(){this.bLoaded=true;this.oImagePreloader.nLoaded++;this.oImagePreloader.onComplete()};ImagePreloader.prototype.onerror=function(){this.bError=true;this.oImagePreloader.onComplete()};ImagePreloader.prototype.onabort=function(){this.bAbort=true;this.oImagePreloader.onComplete()};ImagePreloader.prototype.getBodyImg=function(a){return this.aImages[a]};BasePart.prototype.UP=function(){this.baseY-=2;this.rotY-=2;this.rotY1-=2};BasePart.prototype.DOWN=function(){this.baseY+=2;this.rotY+=2;this.rotY1+=2};BasePart.prototype.LEFT=function(){this.baseX-=2;this.rotX-=2;this.rotX1-=2};BasePart.prototype.RIGHT=function(){this.baseX+=2;this.rotX+=2;this.rotX1+=2};BasePart.prototype.RotRIGHT=function(){this.degree-=10};BasePart.prototype.RotLEFT=function(){this.degree+=10};BasePart.prototype.setBasePos=function(a,b,c){this.baseX+=a;this.baseY+=b;this.rotX+=a;this.rotY+=b;this.rotX1=this.rotX;this.rotY1=this.rotY;this.degree=c};BasePart.prototype.setPos=function(a,b){this.baseX=a+20;this.baseY=b+20};BasePart.prototype.setPosOff=function(a,b){this.offx=a;this.offy=b};BasePart.prototype.setRotPos=function(a,b){this.rotX=a;this.rotY=b};BasePart.prototype.recoverRotPos=function(){this.rotX=this.rotX1;this.rotY=this.rotY1};BasePart.prototype.getRotX=function(){return this.rotX};BasePart.prototype.getRotY=function(){return this.rotY};BasePart.prototype.setOrient=function(a){this.orient=a};BasePart.prototype.setImg=function(a){this.img=a};BasePart.prototype.getName=function(){return this.name};BasePart.prototype.getBaseX=function(){return this.baseX};BasePart.prototype.getBaseY=function(){return this.baseY};BasePart.prototype.getDeg=function(){return this.degree};BasePart.prototype.getInvert=function(){return this.orient};BasePart.prototype.setInvert=function(){if(this.orient=="ld")this.orient="rd";else if(this.orient=="rd")this.orient="ld";else if(this.orient=="lu")this.orient="ru";else if(this.orient=="ru")this.orient="lu"};BasePart.prototype.setInvertVal=function(a){this.orient=a};BasePart.prototype.draw=function(){var a=this.baseX;var b=this.baseY;var c=this.rotX;var d=this.rotY;var e=this.degree;var f;if(isTest)f=140;else f=100;if(this.orient=="rd"||this.orient=="ru"){a=f-this.baseX-this.img.width;c=f-this.rotX;e=0-this.degree}this.drawSprite(this.img,a,b,c,d,e)};BasePart.prototype.getRotTarget=function(a,b,c,d,e){var f=e;var g=Math.sin(f*(Math.PI/180));var h=Math.cos(f*(Math.PI/180));var i=a;var j=b;var k=c;var l=d;x2=(i-k)*h-(j-l)*g+k;y2=(j-l)*h+(i-k)*g+l;return[parseInt(x2),parseInt(y2)]};BasePart.prototype.drawSprite=function(a,b,c,d,e,f){var g=f;var h=Math.sin(g*(Math.PI/180));var i=Math.cos(g*(Math.PI/180));var j=b;var k=c;var l=d+this.offx;var m=e+this.offy;x2=(l-j)*i-(m-k)*h+j;y2=(m-k)*i+(l-j)*h+k;var n=parseInt(x2)-l;var o=parseInt(y2)-m;var p=parseInt(j+64-h*64);var q=parseInt(k-i*64);ctx.save();ctx.translate(j-n,k-o);ctx.rotate(g*(Math.PI/180));ctx.drawImage(a,this.offx,this.offy);ctx.restore()};BodyPart.prototype.drawImage=function(){this.draw();for(var a=0;a<this.accessories.length;a++){this.accessories[a].drawImage()}};BodyPart.prototype.setAccessory=function(a){this.accessories[this.accessories.length]=a};BodyPart.prototype.setUpDnOffset=function(a){this.up_dn_off=a};BodyPart.prototype.setDir=function(a){this.setOrient(a);if((this.orient=="lu"||this.orient=="ru")&&!this.isUPed){this.baseX+=this.up_dn_off[this.name][0];this.baseY+=this.up_dn_off[this.name][1];this.isUPed=true}if((this.orient=="ld"||this.orient=="rd")&&this.isUPed){this.baseX-=this.up_dn_off[this.name][0];this.baseY-=this.up_dn_off[this.name][1];this.isUPed=false}for(var b=0;b<this.accessories.length;b++){this.accessories[b].setOrient(a);if(this.orient=="ld"||this.orient=="rd"){var c=this.baseX+this.accessories[b].off_ox1;var d=this.baseY+this.accessories[b].off_oy1}else if(this.orient=="lu"||this.orient=="ru"){var c=this.baseX+this.accessories[b].off_ox2;var d=this.baseY+this.accessories[b].off_oy2}this.accessories[b].baseX=c;this.accessories[b].baseY=d}};BodyPart.prototype.moveUP=function(){this.UP();for(var a=0;a<this.accessories.length;a++){this.accessories[a].UP()}};BodyPart.prototype.moveDOWN=function(){this.DOWN();for(var a=0;a<this.accessories.length;a++){this.accessories[a].DOWN()}};BodyPart.prototype.moveLEFT=function(){this.LEFT();for(var a=0;a<this.accessories.length;a++){this.accessories[a].LEFT()}};BodyPart.prototype.moveRIGHT=function(){this.RIGHT();for(var a=0;a<this.accessories.length;a++){this.accessories[a].RIGHT()}};BodyPart.prototype.rotRIGHT=function(){this.RotRIGHT();for(var a=0;a<this.accessories.length;a++){this.accessories[a].RotRIGHT()}};BodyPart.prototype.rotLEFT=function(){this.RotLEFT();for(var a=0;a<this.accessories.length;a++){this.accessories[a].RotLEFT()}};BodyPart.prototype.setBodyPos=function(a,b,c,d){var e=a-this.baseX-20;var f=b-this.baseY-5;this.setBasePos(e,f,c);this.setInvertVal(d);for(var g=0;g<this.accessories.length;g++){this.accessories[g].setBasePos(e,f,c);this.accessories[g].setInvertVal(d)}};BodyPart.prototype.invertBody=function(){this.setInvert();for(var a=0;a<this.accessories.length;a++){this.accessories[a].setInvert()}};Accessories.prototype.setOffsetVal=function(a,b,c,d){this.off_ox1=a;this.off_oy1=b;this.off_ox2=c;this.off_oy2=d};Accessories.prototype.setOrient=function(a){this.orient=a};Accessories.prototype.setDisp=function(a){this.disp=a};Accessories.prototype.drawImage=function(){var a=this.name.substring(0,1);if(!(a=="M"&&(this.orient=="lu"||this.orient=="ru"))&&this.disp){this.draw()}};extend(BodyPart,BasePart);extend(Accessories,BasePart);bodyPos.prototype.getRHand1Pos=function(){return[this.pos_arr_dn["rLimb"]["bx_off"]+this.pos_arr_dn["rLimb"]["rx_off"],this.pos_arr_dn["rLimb"]["by_off"]+this.pos_arr_dn["rLimb"]["ry_off"]]};bodyPos.prototype.getRHand1PosAXoff=function(){return[this.pos_arr_dn["rLimb"]["rx_off"],this.pos_arr_dn["rLimb"]["ry_off"]]};bodyPos.prototype.getLHand1Pos=function(){return[this.pos_arr_dn["lLimb"]["bx_off"]+this.pos_arr_dn["lLimb"]["rx_off"],this.pos_arr_dn["lLimb"]["by_off"]+this.pos_arr_dn["lLimb"]["ry_off"]]};bodyPos.prototype.getLHand1PosAXoff=function(){return[this.pos_arr_dn["lLimb"]["rx_off"],this.pos_arr_dn["lLimb"]["ry_off"]]};bodyPos.prototype.getInitalPos=function(a,b){if(a=="ru"||a=="lu")return this.pos_arr_up[b];else if(a=="rd"||a=="ld")return this.pos_arr_dn[b]};bodyPos.prototype.getUpDnOffset=function(){return this.up_dn_offset};bodyPos.prototype.getUpDnOffset_name=function(){return this.up_dn_offset_name};var base_pos=new bodyPos;human.prototype.loadRes=function(){var a=this.inistr;var b=[];var c=[];var d=[];var e=[];var f=a.split("||");var g=f[0];var h=f[1];for(var i=2;i<f.length;i++){var j=f[i].split("_");var k=j[0];var l="human"+h;if(i==9){b.push("res/"+l+"/LD/h"+g+"/"+k+".png");c.push("res/"+l+"/RD/h"+g+"/"+k+".png");d.push("res/"+l+"/LU/h"+g+"/"+k+".png");e.push("res/"+l+"/RU/h"+g+"/"+k+".png")}else if(i==5){b.push("res/"+l+"/LD/b1/"+k+".png");c.push("res/"+l+"/RD/b1/"+k+".png");d.push("res/"+l+"/LU/b1/"+k+".png");e.push("res/"+l+"/RU/b1/"+k+".png")}else{b.push("res/"+l+"/LD/"+k+".png");c.push("res/"+l+"/RD/"+k+".png");d.push("res/"+l+"/LU/"+k+".png");e.push("res/"+l+"/RU/"+k+".png")}for(var m=1;m<j.length;m++){var n=j[m].split(":");var o=n[0];var p=o.substring(1);b.push("res/items/"+p+"/LD/"+o+".png");c.push("res/items/"+p+"/RD/"+o+".png");d.push("res/items/"+p+"/LU/"+o+".png");e.push("res/items/"+p+"/RU/"+o+".png")}}this.ss=new ImagePreloader(b,c,d,e,this)};human.prototype.startUP=function(){var a=20;var b=20;if(isTest){a=40;b=25}var c;var d;var e;var f;var g;var h;var i;var j=base_pos.getUpDnOffset_name();var k=this.inistr.split("||");var l=this.orient;var m;for(var n=2;n<k.length;n++){var o=k[n].split("_");var p=o[0];var q=base_pos.getInitalPos(l,p);c=a+q["bx_off"];d=b+q["by_off"];e=c+q["rx_off"];f=d+q["ry_off"];g=0;m=this.ss.getBodyImg(l+"_"+p);var r=new BodyPart(c,d,e,f,g,m,p,l);r.setUpDnOffset(j);r.setPosOff(this.px,this.py);for(var s=1;s<o.length;s++){var t=o[s].split(":");var u=t[0];m=this.ss.getBodyImg(l+"_"+u);if(l=="ld"||l=="rd"){var v=c+parseInt(t[1]);var w=d+parseInt(t[2])}else if(l=="lu"||l=="ru"){var v=c+parseInt(t[3]);var w=d+parseInt(t[4])}var x=new Accessories(v,w,e,f,g,m,u,l);if(typeof t[5]!="undefined"){h=parseInt(t[4]);h==0?x.disp=false:x.disp=true}else{x.disp=true}x.setOffsetVal(parseInt(t[1]),parseInt(t[2]),parseInt(t[3]),parseInt(t[4]));x.setPosOff(this.px,this.py);r.setAccessory(x)}this.humanObj[this.humanObj.length]=r}if(isTest)this.drawFrame();this.isLoaded=1};human.prototype.setDir=function(a){var b;this.orient=a;for(var c=0;c<this.humanObj.length;c++){var d=this.humanObj[c];d.setDir(a);b=this.ss.getBodyImg(a+"_"+d.getName());d.setImg(b);for(var e=0;e<d.accessories.length;e++){b=this.ss.getBodyImg(d.accessories[e].getInvert()+"_"+d.accessories[e].getName());d.accessories[e].setImg(b)}}if(isTest)this.drawFrame()};human.prototype.resetDirImg=function(a){var b=this.ss.getBodyImg(a.getInvert()+"_"+a.getName());a.setImg(b);for(var c=0;c<a.accessories.length;c++){b=this.ss.getBodyImg(a.accessories[c].getInvert()+"_"+a.accessories[c].getName());a.accessories[c].setImg(b)}};human.prototype.setPOS=function(a){var b=a.split("_");var c,d,e,f,g,h;for(var i=0;i<b.length;i++){c=b[i].split(";");d=parseInt(c[0]);e=parseInt(c[1]);f=parseInt(c[2]);g=c[3];if(typeof c[4]!="undefined"){h=c[4];this.setInvisible(i,h)}if(this.orient=="lu"||this.orient=="ru"){if(this.orient=="ru"){if(g=="ld")g="ru";else if(g=="rd")g="lu"}else if(this.orient=="lu"){if(g=="ld")g="lu";else if(g=="rd")g="ru"}d+=this.dn_up_off[i][0];e+=this.dn_up_off[i][1]}if(this.orient=="rd"){if(g=="ld")g="rd";else if(g=="rd")g="ld"}this.humanObj[i].setBodyPos(d,e,f,g);this.resetDirImg(this.humanObj[i])}};human.prototype.setInvisible=function(a,b){var c;var d=0;this.setAccVisible(a);while(b.length>0){d++;c=parseInt(b.substring(0,1));this.humanObj[a].accessories[c].disp=false;b=b.substring(d,b.length)}};human.prototype.setAccVisible=function(a){for(var b=0;b<this.humanObj[a].accessories.length;b++){this.humanObj[a].accessories[b].disp=true}};human.prototype.getPOS=function(a){var b="";for(var c=0;c<this.humanObj.length;c++){var d=this.humanObj[c];b+=d.getBaseX()+";"+d.getBaseY()+";"+d.getDeg()+";"+d.getInvert()+"_"}return b.substring(0,b.length-1)};human.prototype.animator=function(a){this.aniArr=a.split("&&");this.aniLen=this.aniArr.length;if(isTest)hm_iID=setInterval(this.moveAni,100)};human.prototype.action=function(a){this.actArr=a.split("&&");this.actLen=this.actArr.length};human.prototype.getAniLen=function(){return this.aniLen-1};human.prototype.getActLen=function(){return this.actLen-1};human.prototype.setAniFrame=function(a){a++;var b=this.aniArr[a];this.setPOS(b)};human.prototype.setActFrame=function(a){a++;var b=this.actArr[a];this.setPOS(b)};human.prototype.moveAni=function(){var a=hm.aniArr[hm.aniPoint];hm.setPOS(a);hm.drawFrame();hm.aniPoint++;if(hm.aniPoint==hm.aniArr.length)hm.aniPoint=0};human.prototype.setHMPos=function(a,b){this.px=a-50;this.py=b-120;for(var c=0;c<this.humanObj.length;c++){var d=this.humanObj[c];d.setPosOff(this.px,this.py);for(var e=0;e<d.accessories.length;e++){d.accessories[e].setPosOff(this.px,this.py)}}};human.prototype.drawFrame=function(a){a=typeof a=="undefined"?1:a;var b=[];if(this.orient=="ld"||this.orient=="rd")b=this.overlap_order_dn;else if(this.orient=="lu"||this.orient=="ru")b=this.overlap_order_up;if(isTest)ctx.clearRect(0,0,100,150);for(var c=0;c<this.humanObj.length;c++){this.humanObj[b[c]].drawImage()}};human.prototype.selectBody=function(a){this.selected_body=this.humanObj[a]};human.prototype.recoverSelectedRotPos=function(a){this.humanObj[a].recoverRotPos()};human.prototype.getSelectedRotY=function(a){return this.humanObj[a].getRotY()};human.prototype.moveUP=function(a){this.selected_body.moveUP()};human.prototype.moveDOWN=function(a){this.selected_body.moveDOWN()};human.prototype.moveLEFT=function(a){this.selected_body.moveLEFT()};human.prototype.moveRIGHT=function(a){this.selected_body.moveRIGHT()};human.prototype.rotRIGHT=function(a){this.selected_body.rotRIGHT()};human.prototype.rotLEFT=function(a){this.selected_body.rotLEFT()};human.prototype.invert=function(){this.selected_body.invertBody();this.resetDirImg(this.selected_body)};human.prototype.drawCircle=function(a,b,c){ctx.fillStyle=c;ctx.beginPath();ctx.arc(a,b,1,0,Math.PI*2,true);ctx.fill()};var repeat=0;var dura=0;var m_offx=0;var m_offy=0